<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAC UtilityMapper</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <style>
        :root {
            /* Base Colors */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --success: #16a34a;
            --warning: #eab308;
            --danger: #dc2626;
            --info: #0ea5e9;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #cbd5e1;
            --white: #ffffff;
            --black: #0f172a;
            
            /* Utility Colors */
            --water: #3b82f6;
            --gas: #f97316;
            --electric: #eab308;
            --sewer: #8b5cf6;
            --storm: #14b8a6;
            --telecom: #ec4899;
            
            /* UI Elements */
            --card-bg: rgba(255, 255, 255, 0.96);
            --backdrop: rgba(15, 23, 42, 0.6);
            --navbar: rgba(255, 255, 255, 0.96);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-full: 9999px;
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body, html {
            height: 100%;
            background-color: var(--light);
            color: var(--dark);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* For modern mobile browsers */
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--navbar);
            box-shadow: var(--shadow-sm);
            z-index: 10;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            user-select: none;
            border-bottom: 1px solid rgba(203, 213, 225, 0.5);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary);
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background-color: var(--primary);
            color: white;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius);
            background-color: var(--light);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
        }

        .header-btn:active {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        /* Main Map Container */
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Quick Action Button */
        .quick-action {
            position: absolute;
            bottom: 100px;
            right: 16px;
            z-index: 100;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-full);
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
            font-size: 18px;
        }

        .fab:active {
            transform: scale(0.95);
            background-color: var(--primary-dark);
        }

        .fab i {
            transition: var(--transition);
        }

        .fab.active i {
            transform: rotate(45deg);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: var(--transition);
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .fab-menu.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .fab-button {
            width: 46px;
            height: 46px;
            border-radius: var(--border-radius-full);
            background-color: var(--white);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .fab-label {
            background-color: var(--dark);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
            white-space: nowrap;
            pointer-events: none;
        }

        .fab-item:active .fab-button {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        /* Bottom Toolbar */
        .toolbar {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            gap: 8px;
            z-index: 100;
            border: 1px solid var(--gray-light);
            max-width: 92%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .toolbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        .tool-btn {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            background-color: transparent;
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            outline: none;
            position: relative;
        }

        .tool-btn:active {
            transform: scale(0.97);
        }

        .tool-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .tool-btn .tool-icon {
            font-size: 16px;
        }

        /* Utility Type Selector */
        .utility-selector {
            position: absolute;
            left: 16px;
            top: 80px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 90;
            border: 1px solid var(--gray-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .utility-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            background-color: var(--white);
            font-size: 16px;
            position: relative;
        }

        .utility-btn::after {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .utility-btn.water::after { border-color: var(--water); }
        .utility-btn.gas::after { border-color: var(--gas); }
        .utility-btn.electric::after { border-color: var(--electric); }
        .utility-btn.sewer::after { border-color: var(--sewer); }
        .utility-btn.storm::after { border-color: var(--storm); }
        .utility-btn.telecom::after { border-color: var(--telecom); }

        .utility-btn.active {
            transform: scale(1.1);
        }

        .utility-btn.active.water { background-color: var(--water); color: white; }
        .utility-btn.active.gas { background-color: var(--gas); color: white; }
        .utility-btn.active.electric { background-color: var(--electric); color: white; }
        .utility-btn.active.sewer { background-color: var(--sewer); color: white; }
        .utility-btn.active.storm { background-color: var(--storm); color: white; }
        .utility-btn.active.telecom { background-color: var(--telecom); color: white; }

        .utility-btn:active {
            transform: scale(0.95);
        }

        /* Controls */
        .map-controls {
            position: absolute;
            right: 16px;
            top: 80px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 90;
            border: 1px solid var(--gray-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            background-color: var(--white);
            font-size: 14px;
        }

        .control-btn:active {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        /* Sliding Panel */
        .slide-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 24px 24px 0 0;
            box-shadow: var(--shadow-lg);
            z-index: 200;
            transform: translateY(100%);
            transition: var(--transition-slow);
            max-height: 90vh;
            max-height: 90dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--gray-light);
        }

        .slide-panel.active {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-light);
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .panel-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--dark);
        }

        .panel-close {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius);
            background-color: var(--light);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .panel-close:active {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        .panel-handle {
            width: 40px;
            height: 5px;
            background-color: var(--gray-light);
            border-radius: 2.5px;
            margin: 10px auto;
        }

        .panel-content {
            padding: 20px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--white);
            color: var(--dark);
            outline: none;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .radio-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            outline: none;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid var(--gray-light);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary:active {
            background-color: var(--primary-dark);
        }

        .btn-secondary:active {
            background-color: var(--gray-light);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-light);
            border-radius: 12px;
            transition: .3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Map Elements */
        .utility-marker {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            font-size: 16px;
            position: relative;
        }

        .utility-marker .main-indicator {
            position: absolute;
            bottom: -6px;
            right: -6px;
            background-color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            color: var(--dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .structure-marker {
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            font-size: 18px;
            background-color: var(--white);
            color: var(--dark);
        }

        .measure-label {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--gray-light);
            white-space: nowrap;
        }

        /* Water Animation */
        @keyframes flow {
            0% { stroke-dashoffset: 24; }
            100% { stroke-dashoffset: 0; }
        }

        .water-line {
            stroke-dasharray: 6 4;
            animation: flow 1s linear infinite;
        }

        /* Gas Animation */
        @keyframes gas-pulse {
            0% { stroke-opacity: 0.6; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.6; }
        }

        .gas-line {
            animation: gas-pulse 2s ease-in-out infinite;
        }

        /* Electric Animation */
        @keyframes electric-dash {
            0% { stroke-dashoffset: 40; }
            100% { stroke-dashoffset: 0; }
        }

        .electric-line {
            stroke-dasharray: 10 5;
            animation: electric-dash 2s linear infinite;
        }

        /* Tooltips */
        .tooltip {
            position: absolute;
            background-color: var(--dark);
            color: white;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            max-width: 200px;
            z-index: 1000;
            box-shadow: var(--shadow);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-align: center;
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Status Notification */
        .status-notification {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark);
            color: white;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translate(-50%, -20px);
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }

        .status-notification.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--backdrop);
            z-index: 250;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%);
            background-color: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            width: 90%;
            max-width: 400px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
        }

        .splash-logo {
            width: 100px;
            height: 100px;
            background-color: white;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .splash-logo-inner {
            font-size: 48px;
            color: var(--primary);
        }

        .splash-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .splash-subtitle {
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .splash-logo {
            animation: pulse 2s infinite;
        }

        /* Utility Info Card */
        .utility-info-card {
            position: absolute;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            width: 280px;
            max-width: 90vw;
            display: none;
            border: 1px solid var(--gray-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .utility-info-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .utility-info-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }
        
        .utility-info-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--dark);
        }
        
        .utility-info-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .utility-info-row {
            display: flex;
            justify-content: space-between;
        }
        
        .utility-info-label {
            font-weight: 500;
            font-size: 14px;
            color: var(--gray);
        }
        
        .utility-info-value {
            font-weight: 500;
            font-size: 14px;
            color: var(--dark);
        }
        
        .utility-info-image {
            width: 100%;
            margin-top: 12px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .utility-info-image img {
            width: 100%;
            height: auto;
            object-fit: cover;
            display: block;
        }

        .utility-info-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .utility-action-btn {
            flex: 1;
            padding: 8px;
            border-radius: var(--border-radius);
            background-color: var(--light);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: var(--transition);
        }

        .utility-action-btn:active {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        /* Measurement Control */
        .measurement-control {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 90;
        }

        .measure-value {
            color: var(--primary);
        }

        .measure-action {
            background: none;
            border: none;
            color: var(--dark);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .measure-action:hover {
            background-color: var(--gray-light);
        }

        /* Loading Indicator */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Media Queries */
        @media (max-width: 360px) {
            .utility-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }
            
            .fab {
                width: 48px;
                height: 48px;
                font-size: 16px;
            }
            
            .fab-button {
                width: 40px;
                height: 40px;
            }
            
            .tool-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* iOS safe area support */
        @supports(padding: env(safe-area-inset-bottom)) {
            .toolbar {
                bottom: calc(24px + env(safe-area-inset-bottom));
            }
            
            .quick-action {
                bottom: calc(100px + env(safe-area-inset-bottom));
            }
            
            .slide-panel.active {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Contextual Measurement Tag */
        .measurement-tag {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--gray-light);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .measurement-tag i {
            font-size: 10px;
            color: var(--primary);
        }

        /* Direction Selector */
        .direction-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 16px 0;
        }

        .direction-indicator {
            width: 90px;
            height: 90px;
            background-color: var(--light);
            border-radius: 50%;
            position: relative;
            margin-bottom: 16px;
            border: 1px solid var(--gray-light);
            padding: 8px;
        }

        .direction-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px dashed var(--gray-light);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .direction-arrow {
            color: var(--primary);
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .direction-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .direction-button {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background-color: var(--light);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            cursor: pointer;
            transition: var(--transition);
        }

        .direction-button:active {
            transform: scale(0.95);
            background-color: var(--gray-light);
        }

        .direction-value {
            font-weight: 600;
            font-size: 16px;
            min-width: 60px;
            text-align: center;
        }

        /* Connection Visualization */
        .connection-line {
            stroke-dasharray: 4 4;
            stroke-width: 2;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -8;
            }
        }

        /* Tab Navigation for Forms */
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
            position: relative;
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
            background: none;
            border: none;
            position: relative;
        }

        .tab-button.active {
            color: var(--primary);
        }

        .tab-indicator {
            position: absolute;
            bottom: -1px;
            height: 2px;
            background-color: var(--primary);
            transition: var(--transition);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Structure Selection */
        .structure-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .structure-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .structure-option:hover {
            background-color: var(--light);
        }

        .structure-option.active {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.1);
        }

        .structure-icon {
            font-size: 24px;
            color: var(--dark);
        }

        .structure-label {
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            color: var(--dark);
        }

        /* Measurement Control */
        .segment-connect-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 16px;
            z-index: 300;
            display: none;
            width: 90%;
            max-width: 300px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }

        .segment-connect-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .segment-connect-actions {
            display: flex;
            gap: 12px;
        }

        .segment-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--gray-light);
        }

        .segment-action-btn.connect {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .segment-action-btn.skip {
            background-color: var(--light);
            color: var(--dark);
        }

        .segment-action-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen">
        <div class="splash-logo">
            <div class="splash-logo-inner">
                <i class="fas fa-pipe-section"></i>
            </div>
        </div>
        <div class="splash-title">CAC UtilityMapper</div>
        <div class="splash-subtitle">Professional Utility Tracking</div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator">
        <div class="spinner"></div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <div class="logo-icon">
                    <i class="fas fa-pipe-section"></i>
                </div>
                <div>CAC UtilityMapper</div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="search-btn" title="Search Location">
                    <i class="fas fa-search"></i>
                </button>
                <button class="header-btn" id="menu-btn" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>
        
        <!-- Main Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Utility Type Selector -->
            <div class="utility-selector">
                <button class="utility-btn water active" data-type="water" title="Water">
                    <i class="fas fa-tint"></i>
                </button>
                <button class="utility-btn gas" data-type="gas" title="Gas">
                    <i class="fas fa-fire"></i>
                </button>
                <button class="utility-btn electric" data-type="electric" title="Electric">
                    <i class="fas fa-bolt"></i>
                </button>
                <button class="utility-btn sewer" data-type="sewer" title="Sewer">
                    <i class="fas fa-toilet"></i>
                </button>
                <button class="utility-btn storm" data-type="storm" title="Storm Drain">
                    <i class="fas fa-cloud-rain"></i>
                </button>
                <button class="utility-btn telecom" data-type="telecom" title="Telecom">
                    <i class="fas fa-phone"></i>
                </button>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" id="locate-btn" title="My Location">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" id="zoom-in-btn" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="control-btn" id="zoom-out-btn" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="control-btn" id="layers-btn" title="Layers">
                    <i class="fas fa-layer-group"></i>
                </button>
            </div>
            
            <!-- Bottom Toolbar -->
            <div class="toolbar">
                <button class="tool-btn" id="found-btn">
                    <i class="fas fa-search tool-icon"></i>
                    <span>Mark Found</span>
                </button>
                <button class="tool-btn" id="map-btn">
                    <i class="fas fa-draw-polygon tool-icon"></i>
                    <span>Map Line</span>
                </button>
                <button class="tool-btn" id="structure-btn">
                    <i class="fas fa-cube tool-icon"></i>
                    <span>Structure</span>
                </button>
                <button class="tool-btn" id="measure-btn">
                    <i class="fas fa-ruler tool-icon"></i>
                    <span>Measure</span>
                </button>
            </div>
            
            <!-- Quick Action Button -->
            <div class="quick-action">
                <button class="fab" id="quick-add-btn">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="fab-menu">
                    <div class="fab-item" id="quick-found-btn">
                        <div class="fab-label">Mark Found</div>
                        <div class="fab-button">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <div class="fab-item" id="quick-map-btn">
                        <div class="fab-label">Map Line</div>
                        <div class="fab-button">
                            <i class="fas fa-draw-polygon"></i>
                        </div>
                    </div>
                    <div class="fab-item" id="quick-structure-btn">
                        <div class="fab-label">Add Structure</div>
                        <div class="fab-button">
                            <i class="fas fa-cube"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Measurement Control -->
            <div class="measurement-control" id="measurement-control">
                <span>Distance: </span>
                <span class="measure-value" id="measure-value">0 ft</span>
                <button class="measure-action" id="measure-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Segment Connection UI -->
            <div class="segment-connect-ui" id="segment-connect-ui">
                <div class="segment-connect-title">Connect to nearby utility?</div>
                <div class="segment-connect-actions">
                    <button class="segment-action-btn connect" id="connect-btn">Connect</button>
                    <button class="segment-action-btn skip" id="skip-connect-btn">Skip</button>
                </div>
            </div>

            <!-- Utility Info Card -->
            <div class="utility-info-card" id="utility-info-card">
                <div class="utility-info-header">
                    <div class="utility-info-title">Utility Information</div>
                    <button class="utility-info-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="utility-info-content">
                    <div class="utility-info-row">
                        <div class="utility-info-label">Type:</div>
                        <div class="utility-info-value" id="info-type">Water</div>
                    </div>
                    <div class="utility-info-row">
                        <div class="utility-info-label">Line Type:</div>
                        <div class="utility-info-value" id="info-line-type">Service</div>
                    </div>
                    <div class="utility-info-row">
                        <div class="utility-info-label">Size:</div>
                        <div class="utility-info-value" id="info-size">4 inches</div>
                    </div>
                    <div class="utility-info-row">
                        <div class="utility-info-label">Depth:</div>
                        <div class="utility-info-value" id="info-depth">3 feet</div>
                    </div>
                    <div class="utility-info-row">
                        <div class="utility-info-label">Direction:</div>
                        <div class="utility-info-value" id="info-direction">North</div>
                    </div>
                    <div class="utility-info-row">
                        <div class="utility-info-label">Notes:</div>
                        <div class="utility-info-value" id="info-notes">-</div>
                    </div>
                    <div class="utility-info-image" id="info-media-container">
                        <!-- Media will be inserted here if available -->
                    </div>
                    <div class="utility-info-actions">
                        <button class="utility-action-btn" id="edit-utility-btn">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </button>
                        <button class="utility-action-btn" id="delete-utility-btn">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Notification -->
        <div class="status-notification" id="status-notification">
            Status message goes here
        </div>
        
        <!-- Tooltip -->
        <div class="tooltip" id="tooltip"></div>
        
        <!-- Sliding Panels -->
        <!-- Mark Utility Found Panel -->
        <div class="slide-panel" id="found-panel">
            <div class="panel-handle"></div>
            <div class="panel-header">
                <div class="panel-title">Mark Utility Found</div>
                <button class="panel-close" id="close-found-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label" for="utility-type">Utility Type</label>
                    <select class="form-control" id="utility-type">
                        <option value="water">Water</option>
                        <option value="gas">Gas</option>
                        <option value="electric">Electric</option>
                        <option value="sewer">Sewer</option>
                        <option value="storm">Storm Drain</option>
                        <option value="telecom">Telecom</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Line Type</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" id="main-type" name="line-type" value="main">
                            <span>Main</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" id="service-type" name="line-type" value="service" checked>
                            <span>Service</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="utility-size">Size (inches)</label>
                    <input type="number" class="form-control" id="utility-size" value="4" min="1" max="48">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="utility-depth">Depth (feet)</label>
                    <input type="number" class="form-control" id="utility-depth" value="3" min="1" max="20">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Flow Direction</label>
                    <div class="direction-selector">
                        <div class="direction-indicator">
                            <div class="direction-circle">
                                <i class="fas fa-arrow-up direction-arrow" id="utility-direction-arrow"></i>
                            </div>
                        </div>
                        <div class="direction-controls">
                            <button class="direction-button" id="utility-rotate-left-btn">
                                <i class="fas fa-undo"></i>
                            </button>
                            <div class="direction-value" id="utility-direction-angle">0Â°</div>
                            <button class="direction-button" id="utility-rotate-right-btn">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="utility-notes">Notes</label>
                    <textarea class="form-control" id="utility-notes" rows="2" placeholder="Add any additional details"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="utility-media">Photo/Video (optional)</label>
                    <input type="file" class="form-control" id="utility-media" accept="image/*,video/*">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="utility-measurement">Measurement Tag (optional)</label>
                    <input type="text" class="form-control" id="utility-measurement" placeholder="e.g., 6' from curb">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" id="cancel-utility-btn">Cancel</button>
                    <button class="btn btn-primary" id="confirm-utility-btn">Confirm</button>
                </div>
            </div>
        </div>
        
        <!-- Map Utility Line Panel -->
        <div class="slide-panel" id="map-panel">
            <div class="panel-handle"></div>
            <div class="panel-header">
                <div class="panel-title">Map Utility Line</div>
                <button class="panel-close" id="close-map-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <div class="tab-navigation">
                    <button class="tab-button active" data-tab="map-settings">Settings</button>
                    <button class="tab-button" data-tab="map-instructions">Instructions</button>
                    <div class="tab-indicator" style="left: 0; width: 50%;"></div>
                </div>
                
                <div class="tab-content active" id="map-settings">
                    <div class="form-group">
                        <label class="form-label" for="map-utility-type">Utility Type</label>
                        <select class="form-control" id="map-utility-type">
                            <option value="water">Water</option>
                            <option value="gas">Gas</option>
                            <option value="electric">Electric</option>
                            <option value="sewer">Sewer</option>
                            <option value="storm">Storm Drain</option>
                            <option value="telecom">Telecom</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Line Type</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" id="map-main-type" name="map-line-type" value="main" checked>
                                <span>Main</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" id="map-service-type" name="map-line-type" value="service">
                                <span>Service</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="map-utility-size">Size (inches)</label>
                        <input type="number" class="form-control" id="map-utility-size" value="6" min="1" max="48">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="map-utility-depth">Depth (feet)</label>
                        <input type="number" class="form-control" id="map-utility-depth" value="4" min="1" max="20">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="map-utility-notes">Notes</label>
                        <textarea class="form-control" id="map-utility-notes" rows="2" placeholder="Add any additional details"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="cancel-map-btn">Cancel</button>
                        <button class="btn btn-primary" id="start-mapping-btn">Start Mapping</button>
                    </div>
                </div>
                
                <div class="tab-content" id="map-instructions">
                    <div style="padding: 16px 0;">
                        <h3 style="font-size: 16px; margin-bottom: 16px;">How to Map a Utility Line</h3>
                        <ol style="padding-left: 20px; margin-bottom: 20px;">
                            <li style="margin-bottom: 12px;">Tap the map to place points along the utility path</li>
                            <li style="margin-bottom: 12px;">Double-tap or tap close to the previous point to complete</li>
                            <li style="margin-bottom: 12px;">For service lines, you can connect to existing mains</li>
                            <li>Follow dotted guides for connections to existing utilities</li>
                        </ol>
                        <div style="background-color: var(--light); padding: 12px; border-radius: var(--border-radius); margin-bottom: 16px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Pro Tips:</div>
                            <ul style="padding-left: 20px;">
                                <li style="margin-bottom: 8px;">Use two fingers to pan and zoom while mapping</li>
                                <li style="margin-bottom: 8px;">Tap "Finish" to complete at any time</li>
                                <li>Lines automatically snap to nearby utilities when appropriate</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Structure Panel -->
        <div class="slide-panel" id="structure-panel">
            <div class="panel-handle"></div>
            <div class="panel-header">
                <div class="panel-title">Add Structure</div>
                <button class="panel-close" id="close-structure-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <div class="structure-selection">
                    <div class="structure-option active" data-structure="manhole">
                        <div class="structure-icon">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="structure-label">Manhole</div>
                    </div>
                    <div class="structure-option" data-structure="catch-basin">
                        <div class="structure-icon">
                            <i class="fas fa-drain"></i>
                        </div>
                        <div class="structure-label">Catch Basin</div>
                    </div>
                    <div class="structure-option" data-structure="elec-box">
                        <div class="structure-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="structure-label">Elec. Box</div>
                    </div>
                    <div class="structure-option" data-structure="valve">
                        <div class="structure-icon">
                            <i class="fas fa-tint-slash"></i>
                        </div>
                        <div class="structure-label">Valve</div>
                    </div>
                    <div class="structure-option" data-structure="cleanout">
                        <div class="structure-icon">
                            <i class="fas fa-faucet"></i>
                        </div>
                        <div class="structure-label">Cleanout</div>
                    </div>
                    <div class="structure-option" data-structure="hydrant">
                        <div class="structure-icon">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="structure-label">Hydrant</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="structure-depth">Depth (feet)</label>
                    <input type="number" class="form-control" id="structure-depth" value="4" min="0" max="20">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="structure-notes">Notes</label>
                    <textarea class="form-control" id="structure-notes" rows="2" placeholder="Add any additional details"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="structure-media">Photo/Video (optional)</label>
                    <input type="file" class="form-control" id="structure-media" accept="image/*,video/*">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="structure-measurement">Measurement Tag (optional)</label>
                    <input type="text" class="form-control" id="structure-measurement" placeholder="e.g., 6' from curb">
                </div>
                
                <div class="form-group">
                    <label class="form-label">When Placed</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" id="connect-structure" name="structure-connect" value="connect" checked>
                            <span>Connect to Utilities</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" id="no-connect-structure" name="structure-connect" value="no-connect">
                            <span>Don't Connect</span>
                        </label>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" id="cancel-structure-btn">Cancel</button>
                    <button class="btn btn-primary" id="place-structure-btn">Place Structure</button>
                </div>
            </div>
        </div>
        
        <!-- Measure Panel -->
        <div class="slide-panel" id="measure-panel">
            <div class="panel-handle"></div>
            <div class="panel-header">
                <div class="panel-title">Measurement Tool</div>
                <button class="panel-close" id="close-measure-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <div style="text-align: center; margin-bottom: 24px;">
                    <i class="fas fa-ruler" style="font-size: 36px; color: var(--primary); margin-bottom: 16px;"></i>
                    <div style="font-weight: 600; font-size: 16px;">Measure distances on the map</div>
                    <div style="color: var(--gray); margin-top: 8px;">Tap to start, tap again to end</div>
                </div>
                
                <div style="background-color: var(--light); padding: 16px; border-radius: var(--border-radius); margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Options:</div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="radio-item">
                            <input type="checkbox" id="show-measurement-tag" checked>
                            <span>Add measurement tag when complete</span>
                        </label>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="radio-item">
                            <input type="checkbox" id="snap-to-utilities" checked>
                            <span>Snap to nearby utilities</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Units</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" id="units-feet" name="measure-units" value="feet" checked>
                            <span>Feet</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" id="units-meters" name="measure-units" value="meters">
                            <span>Meters</span>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="start-measuring-btn" style="width: 100%;">
                    Start Measuring
                </button>
                
                <div style="margin-top: 24px; color: var(--gray); font-size: 14px; text-align: center;">
                    Tap on any existing utility to measure its length
                </div>
            </div>
        </div>
    </div>

    <!-- The rest of the modals/panels will be added programmatically -->

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Core Application Variables
            let map;
            let userMarker;
            let currentPosition;
            let activeUtilityType = 'water';
            let activeLineType = 'service';
            let activeStructureType = 'manhole';
            let directionAngle = 0;
            let tempUtilityLocation = null;
            let isDrawing = false;
            let tempLine = null;
            let drawingPoints = [];
            let nearestValidPoint = null;
            let isSnapping = true;
            let isMeasuring = false;
            let measureLine = null;
            let measurePoints = [];
            let selectedUtility = null;
            let activePanel = null;
            let pendingConnectionUtility = null;
            
            // Utility Storage
            const utilities = {
                water: [],
                gas: [],
                electric: [],
                sewer: [],
                storm: [],
                telecom: []
            };
            
            // Structure Storage
            const structures = [];
            
            // Utility Layers
            const utilityLayers = {
                water: L.layerGroup(),
                gas: L.layerGroup(),
                electric: L.layerGroup(),
                sewer: L.layerGroup(),
                storm: L.layerGroup(),
                telecom: L.layerGroup()
            };
            
            // Structure Layer
            const structureLayer = L.layerGroup();
            
            // Measurement Layer
            const measurementLayer = L.layerGroup();
            
            // Colors for utility types
            const utilityColors = {
                water: '#3b82f6',
                gas: '#f97316',
                electric: '#eab308',
                sewer: '#8b5cf6',
                storm: '#14b8a6',
                telecom: '#ec4899'
            };

            // Structure icons and colors
            const structureIcons = {
                'manhole': 'fas fa-circle',
                'catch-basin': 'fas fa-drain',
                'elec-box': 'fas fa-box',
                'valve': 'fas fa-tint-slash',
                'cleanout': 'fas fa-faucet',
                'hydrant': 'fas fa-fire-extinguisher'
            };
            
            const structureColors = {
                'manhole': '#8b5cf6',
                'catch-basin': '#14b8a6',
                'elec-box': '#eab308',
                'valve': '#3b82f6',
                'cleanout': '#8b5cf6', 
                'hydrant': '#ef4444'
            };

            // Initialize the application
            initApp();

            // Initialize the app
            function initApp() {
                // Initialize map
                initMap();
                
                // Initialize event listeners
                initEventListeners();
                
                // Show splash screen for minimum time
                setTimeout(function() {
                    const splashScreen = document.querySelector('.splash-screen');
                    splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 500);
                }, 1500);
            }

            // Initialize the map
            function initMap() {
                // Create map with default view
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    maxZoom: 22
                }).setView([40.7128, -74.0060], 18); // Default NYC view
                
                // Add tile layer (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 22
                }).addTo(map);
                
                // Add all layers to map
                for (const type in utilityLayers) {
                    utilityLayers[type].addTo(map);
                }
                structureLayer.addTo(map);
                measurementLayer.addTo(map);
                
                // Map event listeners
                map.on('click', handleMapClick);
                map.on('contextmenu', function(e) {
                    e.originalEvent.preventDefault();
                    showContextMenu(e);
                });
            }
            
            // Initialize all event listeners
            function initEventListeners() {
                // Utility type selection
                document.querySelectorAll('.utility-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.utility-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                        activeUtilityType = this.getAttribute('data-type');
                        
                        // Update utility type in forms
                        document.getElementById('utility-type').value = activeUtilityType;
                        document.getElementById('map-utility-type').value = activeUtilityType;
                    });
                });
                
                // Map controls
                document.getElementById('locate-btn').addEventListener('click', getUserLocation);
                document.getElementById('zoom-in-btn').addEventListener('click', () => map.zoomIn());
                document.getElementById('zoom-out-btn').addEventListener('click', () => map.zoomOut());
                document.getElementById('layers-btn').addEventListener('click', () => showNotification('Layers panel coming soon'));
                
                // Toolbar buttons
                document.getElementById('found-btn').addEventListener('click', () => openPanel('found-panel'));
                document.getElementById('map-btn').addEventListener('click', () => openPanel('map-panel'));
                document.getElementById('structure-btn').addEventListener('click', () => openPanel('structure-panel'));
                document.getElementById('measure-btn').addEventListener('click', () => openPanel('measure-panel'));
                
                // Quick action button
                document.getElementById('quick-add-btn').addEventListener('click', toggleQuickMenu);
                document.getElementById('quick-found-btn').addEventListener('click', () => {
                    toggleQuickMenu();
                    openPanel('found-panel');
                });
                document.getElementById('quick-map-btn').addEventListener('click', () => {
                    toggleQuickMenu();
                    openPanel('map-panel');
                });
                document.getElementById('quick-structure-btn').addEventListener('click', () => {
                    toggleQuickMenu();
                    openPanel('structure-panel');
                });
                
                // Panel close buttons
                document.querySelectorAll('.panel-close').forEach(btn => {
                    btn.addEventListener('click', () => closePanel(btn.closest('.slide-panel').id));
                });
                
                // Slide panel handle drag functionality
                initPanelDragHandlers();
                
                // Mark Found Panel
                document.getElementById('utility-type').addEventListener('change', function() {
                    activeUtilityType = this.value;
                    
                    // Update utility button selection
                    document.querySelectorAll('.utility-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-type') === activeUtilityType) {
                            btn.classList.add('active');
                        }
                    });
                });
                
                document.querySelectorAll('input[name="line-type"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        activeLineType = this.value;
                    });
                });
                
                document.getElementById('utility-rotate-left-btn').addEventListener('click', function() {
                    directionAngle = (directionAngle - 15) % 360;
                    if (directionAngle < 0) directionAngle += 360;
                    document.getElementById('utility-direction-arrow').style.transform = `rotate(${directionAngle}deg)`;
                    document.getElementById('utility-direction-angle').textContent = `${directionAngle}Â°`;
                });
                
                document.getElementById('utility-rotate-right-btn').addEventListener('click', function() {
                    directionAngle = (directionAngle + 15) % 360;
                    document.getElementById('utility-direction-arrow').style.transform = `rotate(${directionAngle}deg)`;
                    document.getElementById('utility-direction-angle').textContent = `${directionAngle}Â°`;
                });
                
                document.getElementById('cancel-utility-btn').addEventListener('click', function() {
                    closePanel('found-panel');
                    tempUtilityLocation = null;
                });
                
                document.getElementById('confirm-utility-btn').addEventListener('click', function() {
                    if (tempUtilityLocation) {
                        addUtilityFound();
                        closePanel('found-panel');
                    } else {
                        showNotification('Please select a location on the map first');
                    }
                });
                
                // Map Panel
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tabName = this.getAttribute('data-tab');
                        
                        // Update tab buttons
                        document.querySelectorAll('.tab-button').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Update tab indicator
                        const tabIndex = Array.from(this.parentElement.children).indexOf(this);
                        const tabIndicator = this.parentElement.querySelector('.tab-indicator');
                        tabIndicator.style.left = `${tabIndex * 50}%`;
                        
                        // Show tab content
                        document.querySelectorAll('.tab-content').forEach(c => {
                            c.classList.remove('active');
                        });
                        document.getElementById(tabName).classList.add('active');
                    });
                });
                
                document.querySelectorAll('input[name="map-line-type"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        activeLineType = this.value;
                    });
                });
                
                document.getElementById('map-utility-type').addEventListener('change', function() {
                    activeUtilityType = this.value;
                    
                    // Update utility button selection
                    document.querySelectorAll('.utility-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-type') === activeUtilityType) {
                            btn.classList.add('active');
                        }
                    });
                });
                
                document.getElementById('cancel-map-btn').addEventListener('click', function() {
                    closePanel('map-panel');
                });
                
                document.getElementById('start-mapping-btn').addEventListener('click', function() {
                    closePanel('map-panel');
                    startUtilityMapping();
                });
                
                // Structure Panel
                document.querySelectorAll('.structure-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.structure-option').forEach(o => {
                            o.classList.remove('active');
                        });
                        this.classList.add('active');
                        activeStructureType = this.getAttribute('data-structure');
                    });
                });
                
                document.getElementById('cancel-structure-btn').addEventListener('click', function() {
                    closePanel('structure-panel');
                });
                
                document.getElementById('place-structure-btn').addEventListener('click', function() {
                    closePanel('structure-panel');
                    startStructurePlacement();
                });
                
                // Measure Panel
                document.getElementById('measure-close').addEventListener('click', stopMeasuring);
                
                document.getElementById('start-measuring-btn').addEventListener('click', function() {
                    closePanel('measure-panel');
                    startMeasuring();
                });
                
                // Utility Info Card
                document.querySelector('.utility-info-close').addEventListener('click', hideUtilityInfo);
                
                document.getElementById('edit-utility-btn').addEventListener('click', function() {
                    if (selectedUtility) {
                        hideUtilityInfo();
                        editUtility(selectedUtility);
                    }
                });
                
                document.getElementById('delete-utility-btn').addEventListener('click', function() {
                    if (selectedUtility) {
                        hideUtilityInfo();
                        deleteUtility(selectedUtility);
                    }
                });
                
                // Connect UI
                document.getElementById('connect-btn').addEventListener('click', function() {
                    const connectUI = document.getElementById('segment-connect-ui');
                    connectUI.style.display = 'none';
                    
                    if (pendingConnectionUtility) {
                        connectUtilities(pendingConnectionUtility);
                        pendingConnectionUtility = null;
                    }
                });
                
                document.getElementById('skip-connect-btn').addEventListener('click', function() {
                    const connectUI = document.getElementById('segment-connect-ui');
                    connectUI.style.display = 'none';
                    pendingConnectionUtility = null;
                });
            }
            
            // Initialize drag handlers for panels
            function initPanelDragHandlers() {
                const panels = document.querySelectorAll('.slide-panel');
                
                panels.forEach(panel => {
                    const handle = panel.querySelector('.panel-handle');
                    let startY = 0;
                    let currentY = 0;
                    let initialHeight = 0;
                    
                    handle.addEventListener('touchstart', function(e) {
                        startY = e.touches[0].clientY;
                        initialHeight = panel.getBoundingClientRect().height;
                        
                        document.addEventListener('touchmove', moveHandler);
                        document.addEventListener('touchend', endHandler);
                        
                        e.preventDefault();
                    });
                    
                    const moveHandler = function(e) {
                        currentY = e.touches[0].clientY;
                        const deltaY = currentY - startY;
                        
                        // Calculate how far up the panel is from the bottom (as a percentage)
                        const windowHeight = window.innerHeight;
                        const panelHeight = initialHeight - deltaY;
                        const percentUp = (panelHeight / windowHeight) * 100;
                        
                        // If user drags down past a certain threshold, close the panel
                        if (deltaY > 100 || percentUp < 15) {
                            const activePanel = document.querySelector('.slide-panel.active');
                            if (activePanel) {
                                closePanel(activePanel.id);
                            }
                            document.removeEventListener('touchmove', moveHandler);
                            document.removeEventListener('touchend', endHandler);
                            return;
                        }
                        
                        // Otherwise, adjust panel height
                        if (deltaY > 0 && panelHeight > windowHeight * 0.2) {
                            panel.style.height = `${panelHeight}px`;
                        }
                        
                        // If user drags up, expand panel to full height
                        if (deltaY < -50) {
                            panel.style.height = '80vh';
                        }
                    };
                    
                    const endHandler = function() {
                        document.removeEventListener('touchmove', moveHandler);
                        document.removeEventListener('touchend', endHandler);
                        
                        // Reset height to auto after animation completes
                        setTimeout(() => {
                            panel.style.height = '';
                        }, 300);
                    };
                });
            }
            
            // Handle map clicks
            function handleMapClick(e) {
                hideUtilityInfo();
                
                // If actively drawing a utility line
                if (isDrawing) {
                    handleDrawingClick(e.latlng);
                    return;
                }
                
                // If measuring, handle measurement clicks
                if (isMeasuring) {
                    handleMeasurementClick(e.latlng);
                    return;
                }
                
                // If structure placement mode is active
                if (document.body.classList.contains('structure-placement-mode')) {
                    placeStructure(e.latlng);
                    return;
                }
                
                // Check if we're clicking to mark a found utility
                const foundPanel = document.getElementById('found-panel');
                if (foundPanel.classList.contains('active')) {
                    tempUtilityLocation = e.latlng;
                    showNotification('Location selected. Complete the form and tap "Confirm"');
                    return;
                }
            }
            
            // Open a specific panel
            function openPanel(panelId) {
                // Close any active panel first
                const activePanel = document.querySelector('.slide-panel.active');
                if (activePanel && activePanel.id !== panelId) {
                    activePanel.classList.remove('active');
                }
                
                // Open the requested panel
                const panel = document.getElementById(panelId);
                panel.classList.add('active');
                
                // Special handling for found panel
                if (panelId === 'found-panel') {
                    showNotification('Tap on the map to select location');
                    
                    // Update panel with current utility type
                    document.getElementById('utility-type').value = activeUtilityType;
                    
                    // Reset direction angle
                    directionAngle = 0;
                    document.getElementById('utility-direction-arrow').style.transform = `rotate(${directionAngle}deg)`;
                    document.getElementById('utility-direction-angle').textContent = `${directionAngle}Â°`;
                }
            }
            
            // Close a specific panel
            function closePanel(panelId) {
                const panel = document.getElementById(panelId);
                panel.classList.remove('active');
                
                // Reset temp location if found panel
                if (panelId === 'found-panel') {
                    tempUtilityLocation = null;
                }
            }
            
            // Toggle quick menu
            function toggleQuickMenu() {
                const fab = document.getElementById('quick-add-btn');
                const fabMenu = document.querySelector('.fab-menu');
                
                fab.classList.toggle('active');
                fabMenu.classList.toggle('active');
            }
            
            // Show notification
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById('status-notification');
                notification.textContent = message;
                notification.classList.add('visible');
                
                setTimeout(() => {
                    notification.classList.remove('visible');
                }, duration);
            }
            
            // Show tooltip
            function showTooltip(message, x, y) {
                const tooltip = document.getElementById('tooltip');
                tooltip.textContent = message;
                tooltip.style.left = `${x}px`;
                tooltip.style.top = `${y}px`;
                tooltip.classList.add('visible');
                
                setTimeout(() => {
                    tooltip.classList.remove('visible');
                }, 2000);
            }
            
            // Get user location
            function getUserLocation() {
                showNotification('Finding your location...');
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        currentPosition = [position.coords.latitude, position.coords.longitude];
                        
                        // Center map on user location
                        map.setView(currentPosition, 19);
                        
                        // Create or update user marker
                        if (!userMarker) {
                            userMarker = L.circleMarker(currentPosition, {
                                radius: 8,
                                fillColor: '#2563eb',
                                color: '#ffffff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                        } else {
                            userMarker.setLatLng(currentPosition);
                        }
                        
                        showNotification('Location found!');
                    }, function(error) {
                        console.error('Error getting location:', error);
                        showNotification('Unable to get your location. Please try again.');
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    showNotification('Geolocation is not supported by your browser');
                }
            }
            
            // Add utility that was found
            function addUtilityFound() {
                // Get form values
                const utilityType = document.getElementById('utility-type').value;
                const lineType = document.querySelector('input[name="line-type"]:checked').value;
                const size = parseFloat(document.getElementById('utility-size').value) || 4;
                const depth = parseFloat(document.getElementById('utility-depth').value) || 3;
                const notes = document.getElementById('utility-notes').value;
                const measurementTag = document.getElementById('utility-measurement').value;
                
                // Calculate the end point based on direction
                const startPoint = tempUtilityLocation;
                const endPoint = calculateEndPoint(startPoint, directionAngle, 10); // 10 meters length
                
                // Create utility marker
                const markerIcon = createUtilityMarkerIcon(utilityType, lineType);
                const marker = L.marker(startPoint, {
                    icon: markerIcon,
                    draggable: true,
                    utilityType: utilityType,
                    lineType: lineType
                }).addTo(utilityLayers[utilityType]);
                
                // Create utility line with animation class
                const line = L.polyline([startPoint, endPoint], {
                    color: utilityColors[utilityType],
                    weight: lineType === 'main' ? 5 : 3,
                    opacity: 1,
                    className: `${utilityType}-line`,
                    utilityType: utilityType,
                    lineType: lineType
                }).addTo(utilityLayers[utilityType]);
                
                // Add measurement tag if provided
                if (measurementTag) {
                    addMeasurementTag(startPoint, measurementTag);
                }
                
                // Generate a unique ID for the utility
                const utilityId = `utility-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                
                // Process media if uploaded
                const mediaInput = document.getElementById('utility-media');
                let mediaData = null;
                
                if (mediaInput.files && mediaInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mediaData = e.target.result;
                        
                        // Store media with utility
                        const utility = utilities[utilityType].find(u => u.id === utilityId);
                        if (utility) {
                            utility.mediaData = mediaData;
                        }
                    };
                    reader.readAsDataURL(mediaInput.files[0]);
                }
                
                // Create utility data object
                const utilityData = {
                    id: utilityId,
                    type: utilityType,
                    lineType: lineType,
                    size: size,
                    depth: depth,
                    points: [startPoint, endPoint],
                    marker: marker,
                    line: line,
                    angle: directionAngle,
                    notes: notes,
                    measurementTag: measurementTag,
                    mediaData: mediaData,
                    createdAt: new Date()
                };
                
                // Associate marker and line with utilityData
                marker.utilityData = utilityData;
                line.utilityData = utilityData;
                
                // Add to utilities collection
                utilities[utilityType].push(utilityData);
                
                // Add click handlers
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showUtilityInfo(utilityData);
                });
                
                line.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showUtilityInfo(utilityData);
                });
                
                // Update marker/line positions when dragged
                marker.on('drag', function(e) {
                    const newPos = e.target.getLatLng();
                    const linePoints = [...line.getLatLngs()];
                    
                    // Calculate vector of the line
                    const oldStartPoint = linePoints[0];
                    const endPoint = linePoints[linePoints.length - 1];
                    
                    // Calculate vector direction
                    const dx = endPoint.lng - oldStartPoint.lng;
                    const dy = endPoint.lat - oldStartPoint.lat;
                    
                    // Apply the same vector from the new position
                    const newEndPoint = {
                        lat: newPos.lat + dy,
                        lng: newPos.lng + dx
                    };
                    
                    // Update line
                    line.setLatLngs([newPos, newEndPoint]);
                    
                    // Update utility data
                    utilityData.points = [newPos, newEndPoint];
                });
                
                marker.on('dragend', function() {
                    // Check if we should connect to a nearby utility
                    checkForNearbyConnection(utilityData);
                });
                
                // Reset form
                document.getElementById('utility-notes').value = '';
                document.getElementById('utility-measurement').value = '';
                document.getElementById('utility-media').value = '';
                
                // Clear temp location
                tempUtilityLocation = null;
                
                // Show confirmation
                showNotification(`Added ${utilityType} ${lineType}`);
            }
            
            // Start utility line mapping
            function startUtilityMapping() {
                // Reset drawing state
                isDrawing = true;
                drawingPoints = [];
                
                // Show notification
                showNotification('Click to place points. Double-click to finish');
                
                // Set cursor to crosshair
                document.body.style.cursor = 'crosshair';
                
                // Get utility properties from form
                activeUtilityType = document.getElementById('map-utility-type').value;
                activeLineType = document.querySelector('input[name="map-line-type"]:checked').value;
                
                // Add cancel button to toolbar temporarily
                const toolbar = document.querySelector('.toolbar');
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'tool-btn';
                cancelBtn.id = 'cancel-drawing-btn';
                cancelBtn.innerHTML = '<i class="fas fa-times tool-icon"></i><span>Cancel</span>';
                cancelBtn.addEventListener('click', cancelDrawing);
                
                const finishBtn = document.createElement('button');
                finishBtn.className = 'tool-btn';
                finishBtn.id = 'finish-drawing-btn';
                finishBtn.innerHTML = '<i class="fas fa-check tool-icon"></i><span>Finish</span>';
                finishBtn.addEventListener('click', completeDrawing);
                
                toolbar.appendChild(cancelBtn);
                toolbar.appendChild(finishBtn);
            }
            
            // Handle drawing clicks
            function handleDrawingClick(latlng) {
                // Add point to drawing
                drawingPoints.push(latlng);
                
                // If first point, create temporary line
                if (drawingPoints.length === 1) {
                    tempLine = L.polyline([latlng, latlng], {
                        color: utilityColors[activeUtilityType],
                        weight: activeLineType === 'main' ? 5 : 3,
                        opacity: 0.7,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    // Show notification
                    showNotification('Continue adding points. Double-click to finish');
                }
                // If close to the first point and we have at least 3 points, close the line
                else if (drawingPoints.length > 2 && 
                         map.distance(drawingPoints[0], latlng) < 10) {
                    completeDrawing(true); // true = closed loop
                }
                // If double click, finish the line
                else if (drawingPoints.length > 1 && 
                         map.distance(drawingPoints[drawingPoints.length - 2], latlng) < 5) {
                    // Remove the last point (it's too close to the previous one)
                    drawingPoints.pop();
                    completeDrawing();
                }
                else {
                    // Update the temporary line
                    tempLine.setLatLngs(drawingPoints);
                }
                
                // Check for nearby utilities to snap to
                checkNearbyUtilitiesForSnapping(latlng);
            }
            
            // Complete drawing
            function completeDrawing(closedLoop = false) {
                // Need at least 2 points for a valid line
                if (drawingPoints.length < 2) {
                    cancelDrawing();
                    return;
                }
                
                // If it's a closed loop and the first and last points aren't the same,
                // add the first point to the end to close the loop
                if (closedLoop && 
                    drawingPoints[0].lat !== drawingPoints[drawingPoints.length - 1].lat && 
                    drawingPoints[0].lng !== drawingPoints[drawingPoints.length - 1].lng) {
                    drawingPoints.push(drawingPoints[0]);
                }
                
                // Remove the temporary line
                if (tempLine) {
                    map.removeLayer(tempLine);
                    tempLine = null;
                }
                
                // Check for nearby utilities to connect with
                const nearbyUtilities = findNearbyUtilities(drawingPoints[0], activeUtilityType);
                
                // If there's a nearby utility, offer to connect
                if (nearbyUtilities.length > 0 && activeLineType === 'service') {
                    pendingConnectionUtility = {
                        points: drawingPoints,
                        nearbyUtilities: nearbyUtilities
                    };
                    
                    // Show connection UI
                    const connectUI = document.getElementById('segment-connect-ui');
                    connectUI.style.display = 'block';
                } else {
                    // Create the utility line directly
                    createUtilityLine(drawingPoints, activeUtilityType, activeLineType);
                }
                
                // Reset drawing state
                isDrawing = false;
                drawingPoints = [];
                
                // Reset cursor
                document.body.style.cursor = '';
                
                // Remove cancel/finish buttons
                const cancelBtn = document.getElementById('cancel-drawing-btn');
                const finishBtn = document.getElementById('finish-drawing-btn');
                
                if (cancelBtn) cancelBtn.remove();
                if (finishBtn) finishBtn.remove();
            }
            
            // Cancel drawing
            function cancelDrawing() {
                // Remove temporary line
                if (tempLine) {
                    map.removeLayer(tempLine);
                    tempLine = null;
                }
                
                // Reset drawing state
                isDrawing = false;
                drawingPoints = [];
                
                // Reset cursor
                document.body.style.cursor = '';
                
                // Remove cancel/finish buttons
                const cancelBtn = document.getElementById('cancel-drawing-btn');
                const finishBtn = document.getElementById('finish-drawing-btn');
                
                if (cancelBtn) cancelBtn.remove();
                if (finishBtn) finishBtn.remove();
                
                // Show notification
                showNotification('Drawing cancelled');
            }
            
            // Create utility line
            function createUtilityLine(points, utilityType, lineType) {
                // Apply smoothing to the points if needed
                const smoothedPoints = applySmoothingToLine(points);
                
                // Get utility data from form
                const size = parseFloat(document.getElementById('map-utility-size').value) || 6;
                const depth = parseFloat(document.getElementById('map-utility-depth').value) || 4;
                const notes = document.getElementById('map-utility-notes').value;
                
                // Create utility marker at first point
                const markerIcon = createUtilityMarkerIcon(utilityType, lineType);
                const marker = L.marker(smoothedPoints[0], {
                    icon: markerIcon,
                    draggable: true,
                    utilityType: utilityType,
                    lineType: lineType
                }).addTo(utilityLayers[utilityType]);
                
                // Create utility line with animation class
                const line = L.polyline(smoothedPoints, {
                    color: utilityColors[utilityType],
                    weight: lineType === 'main' ? 5 : 3,
                    opacity: 1,
                    className: `${utilityType}-line`,
                    utilityType: utilityType,
                    lineType: lineType
                }).addTo(utilityLayers[utilityType]);
                
                // Generate a unique ID for the utility
                const utilityId = `utility-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                
                // Create utility data object
                const utilityData = {
                    id: utilityId,
                    type: utilityType,
                    lineType: lineType,
                    size: size,
                    depth: depth,
                    points: smoothedPoints,
                    marker: marker,
                    line: line,
                    notes: notes,
                    createdAt: new Date()
                };
                
                // Associate marker and line with utilityData
                marker.utilityData = utilityData;
                line.utilityData = utilityData;
                
                // Add to utilities collection
                utilities[utilityType].push(utilityData);
                
                // Add click handlers
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showUtilityInfo(utilityData);
                });
                
                line.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showUtilityInfo(utilityData);
                });
                
                // Handle marker drag
                marker.on('drag', function(e) {
                    // Only move the first point
                    const newPos = e.target.getLatLng();
                    const linePoints = [...line.getLatLngs()];
                    linePoints[0] = newPos;
                    
                    // Update line
                    line.setLatLngs(linePoints);
                    
                    // Update utility data
                    utilityData.points = linePoints;
                });
                
                // Show confirmation
                showNotification(`Added ${utilityType} ${lineType}`, 2000);
                
                return utilityData;
            }
            
            // Connect utilities
            function connectUtilities(connectionData) {
                if (!connectionData || !connectionData.points || !connectionData.nearbyUtilities) {
                    return;
                }
                
                const points = connectionData.points;
                const nearbyUtil = connectionData.nearbyUtilities[0]; // Take the closest one
                
                // Create a visually connected line between the point and the utility
                let connectedPoints = [...points];
                
                // If the utility is a main, find the nearest point on the main line
                if (nearbyUtil.utility.lineType === 'main') {
                    const mainPoints = nearbyUtil.utility.points;
                    const nearestResult = nearestPointOnPolyline(points[0], mainPoints);
                    
                    // Update the first point to be on the main
                    connectedPoints[0] = nearestResult.point;
                }
                // Otherwise, connect to the marker point
                else {
                    connectedPoints[0] = nearbyUtil.utility.points[0];
                }
                
                // Create the utility line
                const utilityData = createUtilityLine(
                    connectedPoints, 
                    activeUtilityType, 
                    activeLineType
                );
                
                // Store connection data
                utilityData.connectedTo = nearbyUtil.utility.id;
                
                // Show confirmation
                showNotification('Connected to existing utility');
            }
            
            // Check for nearby utilities to snap to
            function checkNearbyUtilitiesForSnapping(latlng) {
                if (!isSnapping) return null;
                
                // Find nearby utilities
                const nearbyUtilities = findNearbyUtilities(latlng, activeUtilityType);
                
                // Show guide line for the nearest utility if any
                if (nearbyUtilities.length > 0) {
                    const nearestUtil = nearbyUtilities[0];
                    
                    // Create an indicator line to show potential connection
                    if (tempLine && drawingPoints.length > 0) {
                        // Add a connection indicator
                        let connectionLine = document.getElementById('connection-indicator');
                        if (!connectionLine) {
                            connectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            connectionLine.setAttribute('id', 'connection-indicator');
                            connectionLine.setAttribute('stroke', utilityColors[activeUtilityType]);
                            connectionLine.setAttribute('stroke-width', '2');
                            connectionLine.setAttribute('stroke-dasharray', '4,4');
                            document.querySelector('svg').appendChild(connectionLine);
                        }
                        
                        // Update connection line
                        // This part would require direct DOM manipulation which is complex here
                        // Will be implemented in a real-world scenario
                    }
                    
                    return nearestUtil;
                }
                
                return null;
            }
            
            // Find nearby utilities
            function findNearbyUtilities(point, utilityType) {
                const nearbyList = [];
                const maxDistance = 20; // meters
                
                // Check utilities of the same type
                utilities[utilityType].forEach(utility => {
                    // Check if we're connecting a service to a main
                    if (activeLineType === 'service' && utility.lineType === 'main') {
                        // Find the nearest point on the main line
                        const nearestResult = nearestPointOnPolyline(point, utility.points);
                        
                        if (nearestResult.distance <= maxDistance) {
                            nearbyList.push({
                                utility: utility,
                                distance: nearestResult.distance,
                                point: nearestResult.point,
                                segmentIndex: nearestResult.index
                            });
                        }
                    }
                    // Check if we're connecting to the start of a line
                    else {
                        const startPoint = utility.points[0];
                        const distance = map.distance(point, startPoint);
                        
                        if (distance <= maxDistance) {
                            nearbyList.push({
                                utility: utility,
                                distance: distance,
                                point: startPoint
                            });
                        }
                    }
                });
                
                // Sort by distance
                return nearbyList.sort((a, b) => a.distance - b.distance);
            }
            
            // Find nearest point on a polyline
            function nearestPointOnPolyline(point, polyline) {
                if (!polyline || polyline.length < 2) {
                    return {
                        point: point,
                        index: 0,
                        distance: Infinity
                    };
                }
                
                let minDist = Infinity;
                let nearestPoint = null;
                let segmentIndex = 0;
                
                for (let i = 0; i < polyline.length - 1; i++) {
                    const result = projectPointOnSegment(point, polyline[i], polyline[i+1]);
                    
                    if (result.distance < minDist) {
                        minDist = result.distance;
                        nearestPoint = result.point;
                        segmentIndex = i;
                    }
                }
                
                return {
                    point: nearestPoint || polyline[0],
                    index: segmentIndex,
                    distance: minDist
                };
            }
            
            // Project a point onto a line segment
            function projectPointOnSegment(point, segStart, segEnd) {
                // Convert to pixel space for more accurate calculations
                const p = map.latLngToLayerPoint(point);
                const s = map.latLngToLayerPoint(segStart);
                const e = map.latLngToLayerPoint(segEnd);
                
                // Vector from start to end
                const sx = e.x - s.x;
                const sy = e.y - s.y;
                
                // Squared length of segment
                const segLengthSq = sx * sx + sy * sy;
                
                // If segment is just a point, return distance to that point
                if (segLengthSq === 0) {
                    return {
                        point: segStart,
                        distance: map.distance(point, segStart)
                    };
                }
                
                // Project point onto segment
                const px = p.x - s.x;
                const py = p.y - s.y;
                
                // Projection of point vector onto segment vector, normalized to segment length
                const proj = (px * sx + py * sy) / segLengthSq;
                
                // If projection is outside segment, clamp to nearest endpoint
                let projX, projY;
                if (proj < 0) {
                    projX = s.x;
                    projY = s.y;
                } else if (proj > 1) {
                    projX = e.x;
                    projY = e.y;
                } else {
                    projX = s.x + proj * sx;
                    projY = s.y + proj * sy;
                }
                
                // Convert projection point back to LatLng
                const projLatLng = map.layerPointToLatLng(L.point(projX, projY));
                
                // Calculate distance from original point to projection
                const distance = map.distance(point, projLatLng);
                
                return {
                    point: projLatLng,
                    distance: distance
                };
            }
            
            // Create utility marker icon
            function createUtilityMarkerIcon(utilityType, lineType) {
                // Get utility icon
                let iconClass;
                switch (utilityType) {
                    case 'water': iconClass = 'fas fa-tint'; break;
                    case 'gas': iconClass = 'fas fa-fire'; break;
                    case 'electric': iconClass = 'fas fa-bolt'; break;
                    case 'sewer': iconClass = 'fas fa-toilet'; break;
                    case 'storm': iconClass = 'fas fa-cloud-rain'; break;
                    case 'telecom': iconClass = 'fas fa-phone'; break;
                    default: iconClass = 'fas fa-question';
                }
                
                // Create HTML for the icon
                const html = `
                    <div class="utility-marker" style="background-color: ${utilityColors[utilityType]};">
                        <i class="${iconClass}"></i>
                        ${lineType === 'main' ? '<div class="main-indicator">M</div>' : ''}
                    </div>
                `;
                
                return L.divIcon({
                    html: html,
                    className: '',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            }
            
            // Create structure marker icon
            function createStructureMarkerIcon(structureType) {
                // Get structure icon
                const iconClass = structureIcons[structureType] || 'fas fa-question';
                
                // Create HTML for the icon
                const html = `
                    <div class="structure-marker" style="color: ${structureColors[structureType]};">
                        <i class="${iconClass}"></i>
                    </div>
                `;
                
                return L.divIcon({
                    html: html,
                    className: '',
                    iconSize: [44, 44],
                    iconAnchor: [22, 22]
                });
            }
            
            // Add measurement tag
            function addMeasurementTag(position, text) {
                const tagIcon = L.divIcon({
                    html: `<div class="measurement-tag"><i class="fas fa-ruler"></i> ${text}</div>`,
                    className: '',
                    iconSize: [120, 24],
                    iconAnchor: [60, 12]
                });
                
                const tagMarker = L.marker(position, {
                    icon: tagIcon,
                    interactive: false
                }).addTo(measurementLayer);
                
                return tagMarker;
            }
            
            // Check if we should connect to nearby utilities
            function checkForNearbyConnection(utilityData) {
                if (!utilityData) return;
                
                // Find nearby utilities
                const nearbyUtilities = findNearbyUtilities(
                    utilityData.points[0], 
                    utilityData.type
                );
                
                // Only proceed if there are nearby utilities
                if (nearbyUtilities.length > 0) {
                    // If it's a service near a main, show connection UI
                    if (utilityData.lineType === 'service' && 
                        nearbyUtilities[0].utility.lineType === 'main') {
                        
                        pendingConnectionUtility = {
                            utilityData: utilityData,
                            nearbyUtilities: nearbyUtilities
                        };
                        
                        // Show connection UI
                        const connectUI = document.getElementById('segment-connect-ui');
                        connectUI.style.display = 'block';
                    }
                }
            }
            
            // Apply bezier smoothing to line points
            function applySmoothingToLine(points) {
                if (points.length <= 2) return points;
                
                const smoothedPoints = [];
                
                // Add first point
                smoothedPoints.push(points[0]);
                
                // Apply bezier smoothing for middle segments
                for (let i = 1; i < points.length - 1; i++) {
                    const prev = points[i - 1];
                    const curr = points[i];
                    const next = points[i + 1];
                    
                    // Calculate control points
                    const controlPoint1 = {
                        lat: prev.lat + (curr.lat - prev.lat) * 0.5,
                        lng: prev.lng + (curr.lng - prev.lng) * 0.5
                    };
                    
                    const controlPoint2 = {
                        lat: curr.lat + (next.lat - curr.lat) * 0.5,
                        lng: curr.lng + (next.lng - curr.lng) * 0.5
                    };
                    
                    // Generate bezier curve points
                    for (let t = 0.1; t <= 0.9; t += 0.2) {
                        const x = Math.pow(1-t, 2) * prev.lng + 
                                2 * (1-t) * t * controlPoint1.lng + 
                                Math.pow(t, 2) * curr.lng;
                                
                        const y = Math.pow(1-t, 2) * prev.lat + 
                                2 * (1-t) * t * controlPoint1.lat + 
                                Math.pow(t, 2) * curr.lat;
                                
                        smoothedPoints.push({lat: y, lng: x});
                    }
                    
                    // Add the current point
                    smoothedPoints.push(curr);
                }
                
                // Add last point
                smoothedPoints.push(points[points.length - 1]);
                
                return smoothedPoints;
            }
            
            // Calculate end point from start, angle and distance
            function calculateEndPoint(startLatLng, angleDegrees, lengthMeters) {
                if (!startLatLng) return null;
                
                // Convert angle to radians (0 is North, clockwise)
                const angleRadians = (90 - angleDegrees) * Math.PI / 180;
                
                // Earth's radius in meters
                const earthRadius = 6378137;
                
                // Angular distance
                const angularDistance = lengthMeters / earthRadius;
                
                // Start point in radians
                const lat1 = startLatLng.lat * Math.PI / 180;
                const lng1 = startLatLng.lng * Math.PI / 180;
                
                // Calculate end point
                const lat2 = Math.asin(
                    Math.sin(lat1) * Math.cos(angularDistance) +
                    Math.cos(lat1) * Math.sin(angularDistance) * Math.cos(angleRadians)
                );
                
                const lng2 = lng1 + Math.atan2(
                    Math.sin(angleRadians) * Math.sin(angularDistance) * Math.cos(lat1),
                    Math.cos(angularDistance) - Math.sin(lat1) * Math.sin(lat2)
                );
                
                // Convert back to degrees
                return {
                    lat: lat2 * 180 / Math.PI,
                    lng: lng2 * 180 / Math.PI
                };
            }
            
            // Start structure placement
            function startStructurePlacement() {
                document.body.classList.add('structure-placement-mode');
                document.body.style.cursor = 'crosshair';
                
                // Show notification
                showNotification('Tap on the map to place the structure');
            }
            
            // Place structure
            function placeStructure(position) {
                // Get structure data
                const structureType = activeStructureType;
                const depth = parseFloat(document.getElementById('structure-depth').value) || 4;
                const notes = document.getElementById('structure-notes').value;
                const measurementTag = document.getElementById('structure-measurement').value;
                const shouldConnect = document.getElementById('connect-structure').checked;
                
                // Create structure marker
                const markerIcon = createStructureMarkerIcon(structureType);
                const marker = L.marker(position, {
                    icon: markerIcon,
                    draggable: true
                }).addTo(structureLayer);
                
                // Process media if uploaded
                const mediaInput = document.getElementById('structure-media');
                let mediaData = null;
                
                if (mediaInput.files && mediaInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mediaData = e.target.result;
                        
                        // Store media with structure
                        const structure = structures.find(s => s.id === structureId);
                        if (structure) {
                            structure.mediaData = mediaData;
                        }
                    };
                    reader.readAsDataURL(mediaInput.files[0]);
                }
                
                // Add measurement tag if provided
                if (measurementTag) {
                    addMeasurementTag(position, measurementTag);
                }
                
                // Generate a unique ID for the structure
                const structureId = `structure-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                
                // Create structure data object
                const structureData = {
                    id: structureId,
                    type: structureType,
                    position: position,
                    depth: depth,
                    notes: notes,
                    marker: marker,
                    measurementTag: measurementTag,
                    mediaData: mediaData,
                    createdAt: new Date()
                };
                
                // Associate marker with structure data
                marker.structureData = structureData;
                
                // Add to structures collection
                structures.push(structureData);
                
                // Add click handler
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showStructureInfo(structureData);
                });
                
                // Connect to nearby utilities if requested
                if (shouldConnect) {
                    connectStructureToUtilities(structureData);
                }
                
                // Reset
                document.body.classList.remove('structure-placement-mode');
                document.body.style.cursor = '';
                
                // Reset form
                document.getElementById('structure-notes').value = '';
                document.getElementById('structure-measurement').value = '';
                document.getElementById('structure-media').value = '';
                
                // Show confirmation
                showNotification(`Added ${structureType}`);
            }
            
            // Connect structure to nearby utilities
            function connectStructureToUtilities(structureData) {
                const position = structureData.position;
                const maxDistance = 20; // meters
                
                // Collect nearby utilities of all types
                const nearbyUtilities = [];
                
                for (const type in utilities) {
                    utilities[type].forEach(utility => {
                        // Find the nearest point on the utility line
                        const nearestResult = nearestPointOnPolyline(position, utility.points);
                        
                        if (nearestResult.distance <= maxDistance) {
                            nearbyUtilities.push({
                                utility: utility,
                                distance: nearestResult.distance,
                                point: nearestResult.point
                            });
                        }
                    });
                }
                
                // Connect to each nearby utility
                nearbyUtilities.forEach(nearby => {
                    // Create a connection line
                    const line = L.polyline([position, nearby.point], {
                        color: utilityColors[nearby.utility.type],
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '5, 5',
                        className: 'connection-line'
                    }).addTo(utilityLayers[nearby.utility.type]);
                    
                    // Store the connection
                    structureData.connections = structureData.connections || [];
                    structureData.connections.push({
                        utilityId: nearby.utility.id,
                        line: line
                    });
                });
                
                if (nearbyUtilities.length > 0) {
                    showNotification(`Connected to ${nearbyUtilities.length} utilities`);
                }
            }
            
            // Show structure info
            function showStructureInfo(structureData) {
                // Implement similar to showUtilityInfo but for structures
                // For brevity, not fully implemented here
                showNotification(`Selected ${structureData.type}`);
            }
            
            // Show utility info
            function showUtilityInfo(utilityData) {
                // Select this utility
                selectedUtility = utilityData;
                
                // Update info card contents
                document.getElementById('info-type').textContent = 
                    utilityData.type.charAt(0).toUpperCase() + utilityData.type.slice(1);
                
                document.getElementById('info-line-type').textContent = 
                    utilityData.lineType.charAt(0).toUpperCase() + utilityData.lineType.slice(1);
                
                document.getElementById('info-size').textContent = `${utilityData.size} inches`;
                document.getElementById('info-depth').textContent = `${utilityData.depth} feet`;
                
                // Calculate length if it's a multi-point line
                if (utilityData.points.length > 1) {
                    let length = 0;
                    for (let i = 0; i < utilityData.points.length - 1; i++) {
                        length += map.distance(utilityData.points[i], utilityData.points[i+1]);
                    }
                    
                    // Add direction info based on start-end direction
                    const start = utilityData.points[0];
                    const end = utilityData.points[utilityData.points.length - 1];
                    const angle = calculateAngle(start, end);
                    
                    document.getElementById('info-direction').textContent = getDirectionName(angle);
                } else {
                    document.getElementById('info-direction').textContent = getDirectionName(utilityData.angle || 0);
                }
                
                // Add notes if available
                document.getElementById('info-notes').textContent = utilityData.notes || '-';
                
                // Handle media if present
                const mediaContainer = document.getElementById('info-media-container');
                if (utilityData.mediaData) {
                    // Check if image or video based on media type
                    if (utilityData.mediaData.startsWith('data:image')) {
                        mediaContainer.innerHTML = `<img src="${utilityData.mediaData}" alt="Utility photo">`;
                    } else if (utilityData.mediaData.startsWith('data:video')) {
                        mediaContainer.innerHTML = `<video controls width="100%"><source src="${utilityData.mediaData}" type="video/mp4"></video>`;
                    }
                    mediaContainer.style.display = 'block';
                } else {
                    mediaContainer.innerHTML = '';
                    mediaContainer.style.display = 'none';
                }
                
                // Position the info card near the utility
                const markerPoint = map.latLngToContainerPoint(utilityData.points[0]);
                const infoCard = document.getElementById('utility-info-card');
                infoCard.style.left = `${markerPoint.x + 20}px`;
                infoCard.style.top = `${Math.max(80, markerPoint.y - 150)}px`;
                
                // Show the card
                infoCard.style.display = 'block';
            }
            
            // Hide utility info
            function hideUtilityInfo() {
                document.getElementById('utility-info-card').style.display = 'none';
                selectedUtility = null;
            }
            
            // Edit utility
            function editUtility(utilityData) {
                // To be implemented - would open edit panel with utility data
                showNotification('Edit functionality coming soon');
            }
            
            // Delete utility
            function deleteUtility(utilityData) {
                // Remove marker and line from map
                if (utilityData.marker) {
                    utilityLayers[utilityData.type].removeLayer(utilityData.marker);
                }
                
                if (utilityData.line) {
                    utilityLayers[utilityData.type].removeLayer(utilityData.line);
                }
                
                // Remove from utilities array
                const index = utilities[utilityData.type].findIndex(u => u.id === utilityData.id);
                if (index !== -1) {
                    utilities[utilityData.type].splice(index, 1);
                }
                
                // Show confirmation
                showNotification('Utility deleted');
            }
            
            // Show context menu
            function showContextMenu(e) {
                // Not fully implemented for brevity
                console.log('Context menu at', e.latlng);
            }
            
            // Calculate angle between two points
            function calculateAngle(start, end) {
                if (!start || !end) return 0;
                
                // Calculate angle in degrees (0 = North, clockwise)
                const dx = end.lng - start.lng;
                const dy = end.lat - start.lat;
                
                // Prevent division by zero
                if (Math.abs(dx) < 1e-10 && Math.abs(dy) < 1e-10) return 0;
                
                let angle = Math.atan2(dx, dy) * 180 / Math.PI;
                
                // Normalize to 0-360
                if (angle < 0) angle += 360;
                
                return angle;
            }
            
            // Get direction name from angle
            function getDirectionName(angle) {
                // Convert angle to compass direction
                const directions = ['North', 'Northeast', 'East', 'Southeast', 
                                   'South', 'Southwest', 'West', 'Northwest'];
                const index = Math.round(((angle + 22.5) % 360) / 45) % 8;
                return directions[index];
            }
            
            // Start measuring
            function startMeasuring() {
                isMeasuring = true;
                measurePoints = [];
                document.body.style.cursor = 'crosshair';
                
                // Show measurement control
                document.getElementById('measurement-control').style.display = 'flex';
                
                // Show notification
                showNotification('Tap to start measuring, tap again to finish');
            }
            
            // Handle measurement click
            function handleMeasurementClick(latlng) {
                // Add point to measurement
                measurePoints.push(latlng);
                
                // If first point, create temporary line
                if (measurePoints.length === 1) {
                    measureLine = L.polyline([latlng, latlng], {
                        color: '#2563eb',
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '5, 5'
                    }).addTo(measurementLayer);
                    
                    // Show notification
                    showNotification('Tap to complete measurement');
                }
                // If second point, complete the measurement
                else if (measurePoints.length === 2) {
                    // Update line
                    measureLine.setLatLngs(measurePoints);
                    
                    // Calculate distance
                    const distance = map.distance(measurePoints[0], measurePoints[1]);
                    
                    // Get units
                    const units = document.getElementById('units-feet').checked ? 'ft' : 'm';
                    const convertedDistance = units === 'ft' ? distance * 3.28084 : distance;
                    
                    // Update measurement control
                    document.getElementById('measure-value').textContent = 
                        `${convertedDistance.toFixed(1)} ${units}`;
                    
                    // Add measurement tag if option checked
                    if (document.getElementById('show-measurement-tag').checked) {
                        // Add at midpoint
                        const midpoint = {
                            lat: (measurePoints[0].lat + measurePoints[1].lat) / 2,
                            lng: (measurePoints[0].lng + measurePoints[1].lng) / 2
                        };
                        
                        addMeasurementTag(midpoint, `${convertedDistance.toFixed(1)} ${units}`);
                    }
                    
                    // Reset for next measurement
                    measurePoints = [];
                    measureLine = null;
                }
            }
            
            // Stop measuring
            function stopMeasuring() {
                isMeasuring = false;
                measurePoints = [];
                
                // Remove temporary line
                if (measureLine) {
                    measurementLayer.removeLayer(measureLine);
                    measureLine = null;
                }
                
                // Hide measurement control
                document.getElementById('measurement-control').style.display = 'none';
                
                // Reset cursor
                document.body.style.cursor = '';
                
                // Show notification
                showNotification('Measurement completed');
            }
        });
    </script>
</body>
</html>
