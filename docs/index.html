<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowMaster Pro 2.0</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <style>
        :root {
            --primary-blue: #2196F3;
            --primary-yellow: #FFC107;
            --primary-red: #F44336;
            --primary-green: #4CAF50;
            --dark-blue: #1976D2;
            --dark-yellow: #FFA000;
            --dark-red: #D32F2F;
            --dark-green: #388E3C;
            --text-dark: #212121;
            --text-light: #FFFFFF;
            --bg-light: #F5F5F5;
            --bg-dark: #263238;
            --gray-light: #EEEEEE;
            --gray-med: #9E9E9E;
            --gray-dark: #616161;
            --shadow-light: 0 2px 5px rgba(0,0,0,0.1);
            --shadow-med: 0 4px 10px rgba(0,0,0,0.15);
            --shadow-dark: 0 6px 15px rgba(0,0,0,0.2);
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 20px;
            --transition-fast: 0.2s ease;
            --transition-med: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            color: var(--text-dark);
            background-color: var(--bg-light);
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .app-container {
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        /* Action button - main floating action button */
        .action-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-med);
            z-index: 1000;
            cursor: pointer;
            transition: var(--transition-med);
        }

        .action-button:active {
            transform: scale(0.95);
            box-shadow: var(--shadow-light);
        }

        .action-button i {
            font-size: 24px;
        }

        /* Action menu - appears when action button is tapped */
        .action-menu {
            position: absolute;
            bottom: 90px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .action-menu.visible {
            display: flex;
        }

        .menu-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-med);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .menu-item:active {
            transform: scale(0.97);
            box-shadow: var(--shadow-light);
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 20px;
        }

        .menu-item.curb-item i {
            color: var(--primary-yellow);
        }

        .menu-item.street-item i {
            color: var(--primary-blue);
        }

        .menu-item.basin-item i {
            color: var(--primary-green);
        }

        .menu-item.highpoint-item i {
            color: var(--primary-red);
        }

        /* Status badge - shows current status */
        .status-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius-xl);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-light);
            max-width: 80%;
            z-index: 900;
        }

        .status-badge i {
            margin-right: 8px;
            color: var(--primary-blue);
        }

        .status-text {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Tools bar - for map control buttons */
        .tools-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 900;
        }

        .tool-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .tool-button:active {
            transform: scale(0.95);
        }

        .tool-button i {
            font-size: 18px;
            color: var(--gray-dark);
        }

        /* Mode indicator - shows current drawing mode */
        .mode-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: white;
            border-radius: var(--border-radius-xl);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-med);
            z-index: 900;
            transition: var(--transition-med);
            transform: translateX(-120%);
        }

        .mode-indicator.visible {
            transform: translateX(0);
        }

        .mode-indicator i {
            margin-right: 8px;
        }

        .mode-indicator .cancel-btn {
            margin-left: 12px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: var(--gray-light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .mode-indicator .cancel-btn i {
            font-size: 12px;
            margin: 0;
            color: var(--gray-dark);
        }

        /* Pitch input overlay */
        .pitch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .pitch-overlay.visible {
            display: flex;
        }

        .pitch-container {
            background-color: white;
            border-radius: var(--border-radius-lg);
            padding: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: var(--shadow-dark);
        }

        .pitch-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .pitch-input {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .pitch-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            outline: none;
            transition: var(--transition-fast);
        }

        .pitch-input input:focus {
            border-color: var(--primary-blue);
        }

        .pitch-input span {
            margin-left: 10px;
            font-size: 16px;
            color: var(--gray-dark);
        }

        .pitch-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .pitch-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .pitch-button.cancel {
            background-color: var(--gray-light);
            color: var(--text-dark);
        }

        .pitch-button.confirm {
            background-color: var(--primary-blue);
            color: white;
        }

        .pitch-button:active {
            transform: scale(0.97);
        }

        /* Map style overrides */
        .pitch-label {
            background-color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 3px 8px;
            font-weight: bold;
            box-shadow: var(--shadow-light);
            white-space: nowrap;
        }

        .arrow-icon {
            background-color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
        }

        .high-point-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
            color: var(--primary-red);
        }

        .catch-basin-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-light);
            color: var(--primary-green);
        }

        .trapped-water {
            background-color: rgba(244, 67, 54, 0.3);
            border: 2px solid var(--primary-red);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px var(--primary-red);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.5);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(33, 150, 243, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spinner 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            font-size: 16px;
            color: var(--text-dark);
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Splash screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-blue);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            transition: opacity 0.5s ease;
        }

        .splash-logo {
            font-size: 50px;
            color: white;
            margin-bottom: 20px;
        }

        .splash-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .splash-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--bg-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-dark);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            max-width: 90%;
            text-align: center;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Help modal */
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .help-modal.visible {
            display: flex;
        }

        .help-container {
            background-color: white;
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-dark);
        }

        .help-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }

        .help-title {
            font-size: 18px;
            font-weight: 600;
        }

        .help-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-dark);
        }

        .help-content {
            padding: 20px;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-heading {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-blue);
        }

        .help-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .help-list {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .help-list li {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .feature-item {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .feature-icon {
            margin-right: 12px;
            flex-shrink: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--gray-light);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .feature-icon i {
            font-size: 16px;
        }

        .feature-text {
            flex: 1;
            font-size: 14px;
        }

        .feature-text strong {
            display: block;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-water"></i>
        </div>
        <div class="splash-title">FlowMaster Pro 2.0</div>
        <div class="splash-subtitle">Advanced Drainage Planning Tool</div>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Map Element -->
        <div id="map"></div>

        <!-- Status Badge -->
        <div class="status-badge">
            <i class="fas fa-map-marker-alt"></i>
            <div class="status-text">Finding your location...</div>
        </div>

        <!-- Tools Bar -->
        <div class="tools-bar">
            <div class="tool-button" id="locate-btn" title="Center on my location">
                <i class="fas fa-crosshairs"></i>
            </div>
            <div class="tool-button" id="clear-btn" title="Clear all">
                <i class="fas fa-trash"></i>
            </div>
            <div class="tool-button" id="help-btn" title="Help">
                <i class="fas fa-question"></i>
            </div>
        </div>

        <!-- Action Button -->
        <div class="action-button" id="action-btn">
            <i class="fas fa-plus"></i>
        </div>

        <!-- Action Menu -->
        <div class="action-menu" id="action-menu">
            <div class="menu-item street-item" id="draw-street-btn">
                <i class="fas fa-road"></i>
                <span>Draw Street Pitch</span>
            </div>
            <div class="menu-item curb-item" id="draw-curb-btn">
                <i class="fas fa-grip-lines"></i>
                <span>Draw Curb Pitch</span>
            </div>
            <div class="menu-item basin-item" id="add-basin-btn">
                <i class="fas fa-drain"></i>
                <span>Add Catch Basin</span>
            </div>
            <div class="menu-item highpoint-item" id="add-highpoint-btn">
                <i class="fas fa-chevron-up"></i>
                <span>Add High Point</span>
            </div>
        </div>

        <!-- Mode Indicator -->
        <div class="mode-indicator" id="mode-indicator">
            <i class="fas fa-pencil-alt"></i>
            <span id="mode-text">Drawing Mode</span>
            <div class="cancel-btn" id="cancel-mode-btn">
                <i class="fas fa-times"></i>
            </div>
        </div>

        <!-- Pitch Input Overlay -->
        <div class="pitch-overlay" id="pitch-overlay">
            <div class="pitch-container">
                <div class="pitch-title" id="pitch-title">Set Pitch Percentage</div>
                <div class="pitch-input">
                    <input type="number" id="pitch-input" min="0.1" max="100" step="0.1" value="2.0">
                    <span>%</span>
                </div>
                <div class="pitch-buttons">
                    <button class="pitch-button cancel" id="pitch-cancel">Cancel</button>
                    <button class="pitch-button confirm" id="pitch-confirm">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="help-modal" id="help-modal">
            <div class="help-container">
                <div class="help-header">
                    <div class="help-title">FlowMaster Pro 2.0 Help</div>
                    <button class="help-close" id="help-close">&times;</button>
                </div>
                <div class="help-content">
                    <div class="help-section">
                        <div class="help-heading">Getting Started</div>
                        <p class="help-text">FlowMaster Pro helps you plan and visualize water drainage on construction sites:</p>
                        <ol class="help-list">
                            <li>Tap the blue + button to access drawing tools</li>
                            <li>Select what you want to add: street pitch, curb pitch, catch basin or high point</li>
                            <li>Follow on-screen instructions to place elements</li>
                            <li>Areas where water might be trapped will automatically highlight in red</li>
                        </ol>
                    </div>

                    <div class="help-section">
                        <div class="help-heading">Key Features</div>
                        
                        <div class="feature-item">
                            <div class="feature-icon" style="background-color: rgba(33, 150, 243, 0.2);">
                                <i class="fas fa-road" style="color: var(--primary-blue);"></i>
                            </div>
                            <div class="feature-text">
                                <strong>Street Pitch (Blue)</strong>
                                Draw lines to indicate street drainage direction. Set the percentage slope and water will flow accordingly.
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon" style="background-color: rgba(255, 193, 7, 0.2);">
                                <i class="fas fa-grip-lines" style="color: var(--primary-yellow);"></i>
                            </div>
                            <div class="feature-text">
                                <strong>Curb Pitch (Yellow)</strong>
                                Draw lines to indicate curb drainage direction. Water flows from high points down toward catch basins.
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon" style="background-color: rgba(76, 175, 80, 0.2);">
                                <i class="fas fa-drain" style="color: var(--primary-green);"></i>
                            </div>
                            <div class="feature-text">
                                <strong>Catch Basins</strong>
                                Mark drainage points where water will collect. All pitches should eventually direct water to these points.
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon" style="background-color: rgba(244, 67, 54, 0.2);">
                                <i class="fas fa-chevron-up" style="color: var(--primary-red);"></i>
                            </div>
                            <div class="feature-text">
                                <strong>High Points</strong>
                                Mark the highest elevation points where water will flow away from.
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon" style="background-color: rgba(244, 67, 54, 0.2);">
                                <i class="fas fa-exclamation-triangle" style="color: var(--primary-red);"></i>
                            </div>
                            <div class="feature-text">
                                <strong>Water Trap Detection</strong>
                                The app automatically detects and highlights areas where water might be trapped (when pitch lines meet without flowing to a catch basin).
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <div class="help-heading">Tips & Tricks</div>
                        <ul class="help-list">
                            <li>Use the locate button to center the map on your current position</li>
                            <li>Clear button removes all elements from the map</li>
                            <li>Make sure to place catch basins at low points where water should drain</li>
                            <li>Any red glowing areas indicate potential drainage problems that need to be fixed</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Loading FlowMaster Pro...</div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet and Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for splash screen
            setTimeout(() => {
                document.querySelector('.splash-screen').style.opacity = 0;
                setTimeout(() => {
                    document.querySelector('.splash-screen').style.display = 'none';
                    init();
                }, 500);
            }, 2000);

            function init() {
                // Initialize variables
                let map, userMarker, currentPosition;
                let drawingMode = null;
                let drawingType = null;
                let tempPolyline = null;
                let pitchPercent = 2.0;
                let drawControl;
                let drawnItems = new L.FeatureGroup(); // All drawn lines
                let catchBasins = new L.FeatureGroup(); // Catch basins
                let highPoints = new L.FeatureGroup(); // High points
                let auxiliaryMarkers = new L.FeatureGroup(); // Labels, arrows, etc.
                let trappedAreas = new L.FeatureGroup(); // Areas where water is trapped
                
                // Colors
                const STREET_COLOR = '#2196F3'; // Blue
                const CURB_COLOR = '#FFC107'; // Yellow
                const HIGH_POINT_COLOR = '#F44336'; // Red
                const BASIN_COLOR = '#4CAF50'; // Green
                const TRAP_COLOR = '#F44336'; // Red

                // Initialize the map
                initMap();

                // Initialize UI interactions
                initUIHandlers();

                function initMap() {
                    // Create map with default view (will be updated with user location)
                    map = L.map('map', {
                        zoomControl: false
                    }).setView([0, 0], 2);

                    // Add zoom control to bottom left
                    L.control.zoom({
                        position: 'bottomleft'
                    }).addTo(map);

                    // Add tile layer (OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 22
                    }).addTo(map);

                    // Add feature groups to map
                    map.addLayer(drawnItems);
                    map.addLayer(catchBasins);
                    map.addLayer(highPoints);
                    map.addLayer(auxiliaryMarkers);
                    map.addLayer(trappedAreas);

                    // Initialize draw control
                    initializeDrawControl();

                    // Get user location
                    getUserLocation();

                    // Map click event handler
                    map.on('click', handleMapClick);
                }

                function initializeDrawControl() {
                    // We'll only use this for programmatic drawing
                    drawControl = new L.Draw.Polyline(map, {
                        shapeOptions: {
                            color: STREET_COLOR,
                            weight: 5,
                            opacity: 0.8
                        }
                    });
                }

                function handleMapClick(e) {
                    if (drawingMode === 'draw') {
                        // If we're not currently drawing a line, start one
                        if (!tempPolyline) {
                            // Create a new polyline with just the click point
                            const color = drawingType === 'street' ? STREET_COLOR : CURB_COLOR;
                            tempPolyline = L.polyline([e.latlng], {
                                color: color,
                                weight: 5,
                                opacity: 0.8
                            }).addTo(map);
                            
                            // Add first point marker to indicate starting point
                            L.circleMarker(e.latlng, {
                                radius: 5,
                                fillColor: color,
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8,
                                className: 'temp-marker'
                            }).addTo(map);
                            
                            showToast("Click to add points, double-click to finish");
                        } else {
                            // Add the new point to the existing polyline
                            const latlngs = tempPolyline.getLatLngs();
                            latlngs.push(e.latlng);
                            tempPolyline.setLatLngs(latlngs);
                            
                            // If we have at least 2 points, show the finish button
                            if (latlngs.length >= 2) {
                                // Check for double click to finish
                                const now = new Date().getTime();
                                if (tempPolyline.lastClickTime && now - tempPolyline.lastClickTime < 300) {
                                    // Double click - finish the line
                                    finishDrawing();
                                } else {
                                    // Single click - update last click time
                                    tempPolyline.lastClickTime = now;
                                }
                            }
                        }
                    } else if (drawingMode === 'catchBasin') {
                        // Add catch basin at click location
                        addCatchBasin(e.latlng);
                        exitDrawingMode();
                    } else if (drawingMode === 'highPoint') {
                        // Add high point at click location
                        addHighPoint(e.latlng);
                        exitDrawingMode();
                    }
                }

                function finishDrawing() {
                    if (tempPolyline && tempPolyline.getLatLngs().length >= 2) {
                        // Save the final polyline
                        const finalPolyline = L.polyline(tempPolyline.getLatLngs(), {
                            color: tempPolyline.options.color,
                            weight: 5,
                            opacity: 0.8,
                            pitchType: drawingType
                        });
                        
                        // Remove temporary polyline and markers
                        map.removeLayer(tempPolyline);
                        document.querySelectorAll('.temp-marker').forEach(marker => {
                            marker.remove();
                        });
                        
                        // Clear the temporary polyline reference
                        tempPolyline = null;
                        
                        // Show pitch input overlay to get the percentage
                        document.getElementById('pitch-title').innerText = 
                            `Set ${drawingType === 'street' ? 'Street' : 'Curb'} Pitch Percentage`;
                        document.getElementById('pitch-overlay').classList.add('visible');
                        document.getElementById('pitch-input').value = pitchPercent;
                        document.getElementById('pitch-input').focus();
                        
                        // Store the polyline temporarily
                        window.tempFinalPolyline = finalPolyline;
                    }
                }

                function confirmPitch() {
                    if (window.tempFinalPolyline) {
                        // Get the input pitch percentage
                        pitchPercent = parseFloat(document.getElementById('pitch-input').value);
                        
                        // Add the pitch property to the polyline
                        window.tempFinalPolyline.options.pitchPercent = pitchPercent;
                        
                        // Add the polyline to the drawn items layer
                        drawnItems.addLayer(window.tempFinalPolyline);
                        
                        // Add direction arrow
                        addDirectionArrow(window.tempFinalPolyline);
                        
                        // Add pitch label
                        addPitchLabel(window.tempFinalPolyline);
                        
                        // Check for trapped water areas
                        detectTrappedWater();
                        
                        // Show toast notification
                        showToast(`Added ${pitchPercent}% ${drawingType} pitch line`);
                        
                        // Exit drawing mode
                        exitDrawingMode();
                        
                        // Clear the temporary final polyline
                        window.tempFinalPolyline = null;
                    }
                    
                    // Hide the pitch overlay
                    document.getElementById('pitch-overlay').classList.remove('visible');
                }

                function cancelPitch() {
                    // Clear the temporary final polyline
                    window.tempFinalPolyline = null;
                    
                    // Hide the pitch overlay
                    document.getElementById('pitch-overlay').classList.remove('visible');
                    
                    // Exit drawing mode
                    exitDrawingMode();
                }

                function addDirectionArrow(polyline) {
                    // Get polyline coordinates
                    const coords = polyline.getLatLngs();
                    if (coords.length < 2) return;
                    
                    // Get midpoint of line
                    const midIndex = Math.floor(coords.length / 2);
                    const midPoint = coords[midIndex];
                    
                    // Get direction angle
                    const prevPoint = coords[midIndex - 1];
                    const angle = getAngle(prevPoint, midPoint);
                    
                    // Create arrow marker
                    const arrowIcon = L.divIcon({
                        html: `<div class="arrow-icon"><i class="fas fa-arrow-down" style="transform: rotate(${angle}deg); color: ${polyline.options.color};"></i></div>`,
                        className: '',
                        iconSize: [24, 24]
                    });
                    
                    // Create marker
                    const arrowMarker = L.marker(midPoint, {
                        icon: arrowIcon,
                        draggable: false,
                        linkedPolylineId: L.stamp(polyline)
                    }).addTo(auxiliaryMarkers);
                    
                    // Store reference to arrow marker
                    polyline.arrowMarkerId = L.stamp(arrowMarker);
                }

                function addPitchLabel(polyline) {
                    // Get polyline coordinates
                    const coords = polyline.getLatLngs();
                    if (coords.length < 2) return;
                    
                    // Get first point of line
                    const point = coords[0];
                    
                    // Create label marker
                    const labelIcon = L.divIcon({
                        html: `<div class="pitch-label" style="border-left: 4px solid ${polyline.options.color};">${polyline.options.pitchPercent}%</div>`,
                        className: '',
                        iconSize: [60, 24]
                    });
                    
                    // Create marker
                    const labelMarker = L.marker(point, {
                        icon: labelIcon,
                        draggable: false,
                        linkedPolylineId: L.stamp(polyline)
                    }).addTo(auxiliaryMarkers);
                    
                    // Store reference to label marker
                    polyline.labelMarkerId = L.stamp(labelMarker);
                }

                function addCatchBasin(latlng) {
                    // Create catch basin icon
                    const catchBasinIcon = L.divIcon({
                        html: `<div class="catch-basin-icon"><i class="fas fa-drain"></i></div>`,
                        className: '',
                        iconSize: [30, 30]
                    });
                    
                    // Create marker
                    const marker = L.marker(latlng, {
                        icon: catchBasinIcon,
                        draggable: true
                    }).addTo(catchBasins);
                    
                    // Add drag end event to re-check trapped water
                    marker.on('dragend', function() {
                        detectTrappedWater();
                    });
                    
                    // Show toast notification
                    showToast("Catch basin added");
                    
                    // Check for trapped water areas
                    detectTrappedWater();
                }

                function addHighPoint(latlng) {
                    // Create high point icon
                    const highPointIcon = L.divIcon({
                        html: `<div class="high-point-icon"><i class="fas fa-chevron-up"></i></div>`,
                        className: '',
                        iconSize: [30, 30]
                    });
                    
                    // Create marker
                    const marker = L.marker(latlng, {
                        icon: highPointIcon,
                        draggable: true
                    }).addTo(highPoints);
                    
                    // Add drag end event to re-check trapped water
                    marker.on('dragend', function() {
                        detectTrappedWater();
                    });
                    
                    // Show toast notification
                    showToast("High point added");
                }

                function getAngle(start, end) {
                    // Calculate angle in degrees
                    const lat1 = start.lat * Math.PI / 180;
                    const lat2 = end.lat * Math.PI / 180;
                    const lng1 = start.lng * Math.PI / 180;
                    const lng2 = end.lng * Math.PI / 180;
                    
                    const y = Math.sin(lng2 - lng1) * Math.cos(lat2);
                    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lng2 - lng1);
                    
                    let angle = Math.atan2(y, x) * 180 / Math.PI;
                    angle = (angle + 360) % 360; // Normalize to 0-360
                    
                    return angle;
                }

                function detectTrappedWater() {
                    // Clear existing trapped areas
                    trappedAreas.clearLayers();
                    
                    // Get all polylines
                    const polylines = [];
                    drawnItems.eachLayer(function(layer) {
                        if (layer instanceof L.Polyline) {
                            polylines.push(layer);
                        }
                    });
                    
                    // If we have less than 2 polylines, there can't be trapped water
                    if (polylines.length < 2) return;
                    
                    // Get all catch basin positions
                    const basinPositions = [];
                    catchBasins.eachLayer(function(layer) {
                        basinPositions.push(layer.getLatLng());
                    });
                    
                    // Check for intersections between polylines
                    const intersections = [];
                    for (let i = 0; i < polylines.length; i++) {
                        for (let j = i + 1; j < polylines.length; j++) {
                            const intersection = findIntersection(polylines[i], polylines[j]);
                            if (intersection) {
                                intersections.push({
                                    point: intersection,
                                    lines: [polylines[i], polylines[j]]
                                });
                            }
                        }
                    }
                    
                    // Check each intersection to see if water would be trapped
                    intersections.forEach(intersection => {
                        const point = intersection.point;
                        const lines = intersection.lines;
                        
                        // Check if any catch basin is close to this intersection
                        const hasNearbyCatchBasin = basinPositions.some(basinPos => {
                            const distance = map.distance(point, basinPos);
                            return distance < 20; // 20 meters threshold
                        });
                        
                        // If there's a nearby catch basin, water won't be trapped
                        if (hasNearbyCatchBasin) return;
                        
                        // Get the flow directions of the two lines
                        const flows = lines.map(line => {
                            const coords = line.getLatLngs();
                            const firstPoint = coords[0];
                            const lastPoint = coords[coords.length - 1];
                            
                            // Calculate distances from intersection to start and end points
                            const distToStart = map.distance(point, firstPoint);
                            const distToEnd = map.distance(point, lastPoint);
                            
                            // If intersection is closer to end, water flows toward intersection
                            // If intersection is closer to start, water flows away from intersection
                            return distToEnd < distToStart ? 'toward' : 'away';
                        });
                        
                        // If both lines flow toward the intersection, water will be trapped
                        if (flows[0] === 'toward' && flows[1] === 'toward') {
                            // Create trapped water marker
                            const trappedIcon = L.divIcon({
                                html: `<div class="trapped-water"><i class="fas fa-exclamation-triangle" style="color: ${TRAP_COLOR};"></i></div>`,
                                className: '',
                                iconSize: [30, 30]
                            });
                            
                            // Add marker
                            const marker = L.marker(point, {
                                icon: trappedIcon,
                                draggable: false
                            }).addTo(trappedAreas);
                            
                            // Show warning toast
                            showToast("Warning: Water trap detected! Add a catch basin at this location.");
                        }
                    });
                }

                function findIntersection(line1, line2) {
                    // Get coordinates of both lines
                    const coords1 = line1.getLatLngs();
                    const coords2 = line2.getLatLngs();
                    
                    // Check each segment of line1 against each segment of line2
                    for (let i = 0; i < coords1.length - 1; i++) {
                        for (let j = 0; j < coords2.length - 1; j++) {
                            const seg1 = [coords1[i], coords1[i + 1]];
                            const seg2 = [coords2[j], coords2[j + 1]];
                            
                            const intersection = segmentIntersection(seg1, seg2);
                            if (intersection) {
                                return intersection;
                            }
                        }
                    }
                    
                    return null;
                }

                function segmentIntersection(seg1, seg2) {
                    // Extract points
                    const p1 = seg1[0], p2 = seg1[1];
                    const p3 = seg2[0], p4 = seg2[1];
                    
                    // Convert to simple x,y coordinates
                    const x1 = p1.lng, y1 = p1.lat;
                    const x2 = p2.lng, y2 = p2.lat;
                    const x3 = p3.lng, y3 = p3.lat;
                    const x4 = p4.lng, y4 = p4.lat;
                    
                    // Check if segments intersect
                    const d = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);
                    if (d === 0) return null; // Parallel lines
                    
                    const ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / d;
                    const ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / d;
                    
                    // Check if intersection is on both segments
                    if (ua < 0 || ua > 1 || ub < 0 || ub > 1) return null;
                    
                    // Calculate intersection point
                    const x = x1 + ua * (x2 - x1);
                    const y = y1 + ua * (y2 - y1);
                    
                    return L.latLng(y, x);
                }

                function enterDrawingMode(mode, type) {
                    // Set drawing mode
                    drawingMode = mode;
                    drawingType = type;
                    
                    // Update mode indicator
                    const modeIndicator = document.getElementById('mode-indicator');
                    const modeText = document.getElementById('mode-text');
                    
                    if (mode === 'draw') {
                        if (type === 'street') {
                            modeText.innerText = 'Drawing Street Pitch';
                            modeIndicator.querySelector('i').className = 'fas fa-road';
                            modeIndicator.querySelector('i').style.color = STREET_COLOR;
                        } else {
                            modeText.innerText = 'Drawing Curb Pitch';
                            modeIndicator.querySelector('i').className = 'fas fa-grip-lines';
                            modeIndicator.querySelector('i').style.color = CURB_COLOR;
                        }
                    } else if (mode === 'catchBasin') {
                        modeText.innerText = 'Adding Catch Basin';
                        modeIndicator.querySelector('i').className = 'fas fa-drain';
                        modeIndicator.querySelector('i').style.color = BASIN_COLOR;
                    } else if (mode === 'highPoint') {
                        modeText.innerText = 'Adding High Point';
                        modeIndicator.querySelector('i').className = 'fas fa-chevron-up';
                        modeIndicator.querySelector('i').style.color = HIGH_POINT_COLOR;
                    }
                    
                    // Show mode indicator
                    modeIndicator.classList.add('visible');
                    
                    // Hide action menu
                    document.getElementById('action-menu').classList.remove('visible');
                }

                function exitDrawingMode() {
                    // Reset drawing mode
                    drawingMode = null;
                    drawingType = null;
                    
                    // Hide mode indicator
                    document.getElementById('mode-indicator').classList.remove('visible');
                    
                    // Remove any temporary drawing
                    if (tempPolyline) {
                        map.removeLayer(tempPolyline);
                        tempPolyline = null;
                    }
                    
                    // Remove any temporary markers
                    document.querySelectorAll('.temp-marker').forEach(marker => {
                        marker.remove();
                    });
                }

                function getUserLocation() {
                    // Update status
                    updateStatus('Finding your location...');
                    
                    // Show loading overlay
                    document.querySelector('.loading-overlay').style.display = 'flex';
                    
                    // Check if geolocation is available
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            // Store position
                            currentPosition = [position.coords.latitude, position.coords.longitude];
                            
                            // Update map center
                            map.setView(currentPosition, 19);
                            
                            // Create user marker if not exists
                            if (!userMarker) {
                                userMarker = L.circleMarker(currentPosition, {
                                    radius: 8,
                                    fillColor: '#2196F3',
                                    color: '#fff',
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                }).addTo(map);
                            } else {
                                userMarker.setLatLng(currentPosition);
                            }
                            
                            // Update status
                            updateStatus('Current location');
                            
                            // Hide loading overlay
                            document.querySelector('.loading-overlay').style.display = 'none';
                            
                            // Watch position for updates
                            navigator.geolocation.watchPosition(function(position) {
                                // Update current position
                                currentPosition = [position.coords.latitude, position.coords.longitude];
                                
                                // Update user marker
                                if (userMarker) {
                                    userMarker.setLatLng(currentPosition);
                                }
                            }, function(error) {
                                console.error('Error watching position:', error);
                            }, {
                                enableHighAccuracy: true,
                                maximumAge: 0,
                                timeout: 5000
                            });
                            
                        }, function(error) {
                            console.error('Error getting location:', error);
                            
                            // Update status
                            updateStatus('Location access denied');
                            
                            // Hide loading overlay
                            document.querySelector('.loading-overlay').style.display = 'none';
                            
                            // Set default view
                            map.setView([40.7128, -74.0060], 14);
                            
                            // Show toast notification
                            showToast("Please enable location access for best experience");
                        }, {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 5000
                        });
                    } else {
                        // Update status
                        updateStatus('Location not supported');
                        
                        // Hide loading overlay
                        document.querySelector('.loading-overlay').style.display = 'none';
                        
                        // Set default view
                        map.setView([40.7128, -74.0060], 14);
                        
                        // Show toast notification
                        showToast("Your browser doesn't support geolocation");
                    }
                }

                function updateStatus(message) {
                    document.querySelector('.status-text').textContent = message;
                }

                function showToast(message) {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('visible');
                    
                    setTimeout(() => {
                        toast.classList.remove('visible');
                    }, 3000);
                }

                function clearAll() {
                    // Clear all layers
                    drawnItems.clearLayers();
                    catchBasins.clearLayers();
                    highPoints.clearLayers();
                    auxiliaryMarkers.clearLayers();
                    trappedAreas.clearLayers();
                    
                    // Exit drawing mode
                    exitDrawingMode();
                    
                    // Show toast notification
                    showToast("All items cleared");
                }

                function initUIHandlers() {
                    // Action button click handler
                    document.getElementById('action-btn').addEventListener('click', function() {
                        document.getElementById('action-menu').classList.toggle('visible');
                    });
                    
                    // Draw street button click handler
                    document.getElementById('draw-street-btn').addEventListener('click', function() {
                        enterDrawingMode('draw', 'street');
                    });
                    
                    // Draw curb button click handler
                    document.getElementById('draw-curb-btn').addEventListener('click', function() {
                        enterDrawingMode('draw', 'curb');
                    });
                    
                    // Add catch basin button click handler
                    document.getElementById('add-basin-btn').addEventListener('click', function() {
                        enterDrawingMode('catchBasin');
                    });
                    
                    // Add high point button click handler
                    document.getElementById('add-highpoint-btn').addEventListener('click', function() {
                        enterDrawingMode('highPoint');
                    });
                    
                    // Cancel mode button click handler
                    document.getElementById('cancel-mode-btn').addEventListener('click', function() {
                        exitDrawingMode();
                    });
                    
                    // Pitch confirm button click handler
                    document.getElementById('pitch-confirm').addEventListener('click', function() {
                        confirmPitch();
                    });
                    
                    // Pitch cancel button click handler
                    document.getElementById('pitch-cancel').addEventListener('click', function() {
                        cancelPitch();
                    });
                    
                    // Handle Enter key in pitch input
                    document.getElementById('pitch-input').addEventListener('keyup', function(e) {
                        if (e.key === 'Enter') {
                            confirmPitch();
                        }
                    });
                    
                    // Locate button click handler
                    document.getElementById('locate-btn').addEventListener('click', function() {
                        if (currentPosition) {
                            map.setView(currentPosition, 19);
                            showToast("Centered on current location");
                        } else {
                            getUserLocation();
                        }
                    });
                    
                    // Clear button click handler
                    document.getElementById('clear-btn').addEventListener('click', function() {
                        // Ask for confirmation
                        if (confirm('Are you sure you want to clear all items?')) {
                            clearAll();
                        }
                    });
                    
                    // Help button click handler
                    document.getElementById('help-btn').addEventListener('click', function() {
                        document.getElementById('help-modal').classList.add('visible');
                    });
                    
                    // Help close button click handler
                    document.getElementById('help-close').addEventListener('click', function() {
                        document.getElementById('help-modal').classList.remove('visible');
                    });
                    
                    // Close help modal when clicking outside
                    document.getElementById('help-modal').addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.remove('visible');
                        }
                    });
                    
                    // Close pitch overlay when clicking outside
                    document.getElementById('pitch-overlay').addEventListener('click', function(e) {
                        if (e.target === this) {
                            cancelPitch();
                        }
                    });
                    
                    // Click away from menu to close it
                    document.addEventListener('click', function(e) {
                        const actionMenu = document.getElementById('action-menu');
                        const actionBtn = document.getElementById('action-btn');
                        
                        if (actionMenu.classList.contains('visible') && 
                            !actionMenu.contains(e.target) && 
                            e.target !== actionBtn && 
                            !actionBtn.contains(e.target)) {
                            actionMenu.classList.remove('visible');
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
